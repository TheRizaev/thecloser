import os
import django

# 1. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Django, —á—Ç–æ–±—ã —Å–∫—Ä–∏–ø—Ç –≤–∏–¥–µ–ª –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
# (–ï—Å–ª–∏ –≤–∞—à –ø—Ä–æ–µ–∫—Ç –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è –Ω–µ 'config', –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª manage.py, –Ω–æ –æ–±—ã—á–Ω–æ —ç—Ç–æ config.settings)
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
django.setup()

from django.contrib.auth import authenticate
from django.contrib.auth.models import User

def check_and_fix():
    print("\n" + "="*50)
    print("üöë –ú–ê–°–¢–ï–† –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Ø –í–•–û–î–ê")
    print("="*50)
    
    # –°–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    email = input("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Email (–∫–∞–∫ –ø—Ä–∏ –≤—Ö–æ–¥–µ): ").strip()
    password = input("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ü–∞—Ä–æ–ª—å: ").strip()
    
    print(f"\nüîç –ü—Ä–æ–≤–µ—Ä—è—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è: {email}...")

    # 1. –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–±–µ–∑ —É—á–µ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞ –±—É–∫–≤)
    users = User.objects.filter(email__iexact=email)
    count = users.count()

    if count == 0:
        print(f"‚ùå –û–®–ò–ë–ö–ê: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å email '{email}' –ù–ï –ù–ê–ô–î–ï–ù.")
        print("   –í–æ–∑–º–æ–∂–Ω–æ, –≤—ã —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å —Å –æ–ø–µ—á–∞—Ç–∫–æ–π.")
        print("\n   –í–æ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö email, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ –±–∞–∑–µ:")
        for u in User.objects.all():
            print(f"   - {u.email} (–õ–æ–≥–∏–Ω: {u.username})")
        return

    if count > 1:
        print(f"‚ùå –û–®–ò–ë–ö–ê: –ù–∞–π–¥–µ–Ω–æ {count} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –æ–¥–∏–Ω–∞–∫–æ–≤–æ–π –ø–æ—á—Ç–æ–π!")
        print("   –≠—Ç–æ —Å–±–∏–≤–∞–µ—Ç Django —Å —Ç–æ–ª–∫—É. –ù—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –ª–∏—à–Ω–∏—Ö —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É.")
        return

    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω
    u = users.first()
    print(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω: –õ–æ–≥–∏–Ω='{u.username}', ID={u.id}")

    # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    if not u.is_active:
        print("‚ùå –û–®–ò–ë–ö–ê: –ê–∫–∫–∞—É–Ω—Ç –æ—Ç–∫–ª—é—á–µ–Ω (is_active=False).")
        fix = input("   >>> –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ? (y/n): ")
        if fix.lower() == 'y':
            u.is_active = True
            u.save()
            print("   ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –ê–∫–∫–∞—É–Ω—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω.")
        else:
            print("   –ü—Ä–æ–ø—É—Å–∫–∞–µ–º.")

    # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–æ–ª—å
    if u.check_password(password):
        print("‚úÖ –ü–ê–†–û–õ–¨: –í–µ—Ä–Ω—ã–π.")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é —Ü–µ–ª–∏–∫–æ–º
        auth_user = authenticate(username=u.username, password=password)
        if auth_user:
            print("üéâ –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –†–ê–ë–û–¢–ê–ï–¢ –ò–î–ï–ê–õ–¨–ù–û.")
            print("   –ï—Å–ª–∏ –≤—ã –Ω–µ –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏ –Ω–∞ —Å–∞–π—Ç–µ -> –ø—Ä–æ–±–ª–µ–º–∞ —Ç–æ—á–Ω–æ –≤ –∫–æ–¥–µ views.py –∏–ª–∏ html.")
        else:
            print("ü§î –ü–∞—Ä–æ–ª—å –≤–µ—Ä–Ω—ã–π, –Ω–æ authenticate() –≤–µ—Ä–Ω—É–ª None.")
    else:
        print("‚ùå –ü–ê–†–û–õ–¨: –ù–ï–í–ï–†–ù–´–ô.")
        fix = input("   >>> –°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å –Ω–∞ —ç—Ç–æ—Ç (–∫–æ—Ç–æ—Ä—ã–π –≤—ã –≤–≤–µ–ª–∏)? (y/n): ")
        if fix.lower() == 'y':
            u.set_password(password)
            u.save()
            print(f"   ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: –¢–µ–ø–µ—Ä—å –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥–∞: {password}")
            
    print("\n" + "="*50)
    print("–ì–æ—Ç–æ–≤–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ–π—Ç–∏ –Ω–∞ —Å–∞–π—Ç.")

if __name__ == "__main__":
    try:
        check_and_fix()
    except Exception as e:
        print(f"\n‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ: {e}")
        print("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ñ–∞–π–ª –ª–µ–∂–∏—Ç –≤ —Ç–æ–π –∂–µ –ø–∞–ø–∫–µ, —á—Ç–æ –∏ manage.py")