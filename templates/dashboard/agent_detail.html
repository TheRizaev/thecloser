{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}{{ bot.name }} — Управление агентом{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    :root {
        --provider-openai: #10a37f;
        --provider-google: #4285f4;
        --provider-anthropic: #d97757;
        --bg-modal: rgba(0, 0, 0, 0.85);
        --surface-dark: #1e293b;
        --surface-darker: #0f172a;
    }

    .bot-detail-container {
        max-width: 1600px;
        margin: 0 auto;
        padding-bottom: 60px;
    }

    /* --- Header Card --- */
    .bot-header-card {
        background: var(--dash-surface);
        border: 1px solid var(--dash-border);
        border-radius: 24px;
        padding: 32px;
        margin-bottom: 32px;
        display: flex;
        gap: 32px;
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(20px);
    }

    .bot-header-bg-glow {
        position: absolute;
        top: -50%;
        right: -10%;
        width: 600px;
        height: 600px;
        background: radial-gradient(circle, rgba(99, 102, 241, 0.15) 0%, transparent 70%);
        pointer-events: none;
        z-index: 0;
    }

    .bot-avatar-xl {
        width: 140px;
        height: 140px;
        background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9));
        border-radius: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 56px;
        flex-shrink: 0;
        border: 1px solid rgba(255, 255, 255, 0.05);
        box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.3);
        z-index: 1;
        color: var(--dash-primary);
    }

    .bot-header-info {
        flex: 1;
        z-index: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .bot-title-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
    }

    .bot-header-info h1 {
        font-size: 36px;
        margin: 0 0 12px 0;
        font-weight: 800;
        letter-spacing: -1px;
        background: linear-gradient(to right, #fff, #94a3b8);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .bot-badges {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .status-badge {
        padding: 6px 14px;
        border-radius: 100px;
        font-size: 13px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .status-badge.active { background: rgba(34, 197, 94, 0.1); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.2); }
    .status-badge.inactive { background: rgba(239, 68, 68, 0.1); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.2); }

    .header-actions {
        display: flex;
        gap: 12px;
    }

    /* --- Tabs Styling --- */
    .tabs-container {
        margin-bottom: 32px;
    }

    .tabs-nav {
        display: flex;
        gap: 8px;
        padding: 6px;
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid var(--dash-border);
        border-radius: 16px;
        width: fit-content;
        margin-bottom: 24px;
    }

    .tab-button {
        padding: 12px 24px;
        border: none;
        background: transparent;
        color: var(--dash-text-muted);
        font-size: 14px;
        font-weight: 600;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .tab-button:hover { color: #fff; background: rgba(255, 255, 255, 0.03); }
    
    .tab-button.active {
        background: var(--dash-primary);
        color: white;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }

    .tab-content { display: none; animation: slideUp 0.3s ease-out; }
    .tab-content.active { display: block; }
    
    @keyframes slideUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* --- Configuration Forms --- */
    .config-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 24px;
    }

    .config-card {
        background: var(--dash-surface);
        border: 1px solid var(--dash-border);
        border-radius: 20px;
        padding: 28px;
    }

    .form-group { margin-bottom: 24px; }
    
    .form-label {
        display: block;
        font-size: 13px;
        font-weight: 700;
        margin-bottom: 10px;
        color: var(--dash-text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .form-input, .form-textarea, .form-select {
        width: 100%;
        background: var(--surface-darker);
        border: 1px solid var(--dash-border);
        border-radius: 12px;
        padding: 16px;
        color: #fff;
        font-size: 15px;
        transition: border-color 0.2s;
    }

    .form-input:focus, .form-textarea:focus, .form-select:focus {
        outline: none;
        border-color: var(--dash-primary);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
    }

    /* Model Select Styling */
    .optgroup-openai { color: var(--provider-openai); font-weight: 800; background: #1e293b; }
    .optgroup-google { color: var(--provider-google); font-weight: 800; background: #1e293b; }
    .optgroup-anthropic { color: var(--provider-anthropic); font-weight: 800; background: #1e293b; }
    option { color: #fff; font-weight: normal; padding: 10px; }

    /* Prompt Preview */
    .prompt-preview-box {
        background: var(--surface-darker);
        border: 1px dashed var(--dash-border);
        border-radius: 16px;
        padding: 24px;
        min-height: 140px;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
    }
    .prompt-preview-box:hover {
        border-color: var(--dash-primary);
        background: rgba(15, 23, 42, 0.8);
    }
    .prompt-preview-text {
        font-family: 'JetBrains Mono', 'Fira Code', monospace;
        color: var(--dash-text-muted);
        font-size: 13px;
        line-height: 1.6;
        display: -webkit-box;
        -webkit-line-clamp: 6;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* --- FULLSCREEN MODAL --- */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: var(--bg-modal);
        backdrop-filter: blur(8px);
        /* Ставим максимальный z-index, чтобы перекрыть любые сайдбары */
        z-index: 2147483647; 
        display: none;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .modal-overlay.open {
        display: flex;
        opacity: 1;
    }

    .modal-content {
        background: var(--surface-dark);
        width: 90vw;
        height: 90vh;
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 50px 100px -20px rgba(0, 0, 0, 0.7);
        display: flex;
        flex-direction: column;
        transform: scale(0.95);
        transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .modal-overlay.open .modal-content { transform: scale(1); }

    .modal-header {
        padding: 24px 32px;
        border-bottom: 1px solid var(--dash-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--surface-darker);
        border-radius: 20px 20px 0 0;
    }

    /* Контейнер тела модалки должен растягиваться на всю доступную высоту */
    .modal-body {
        flex: 1 1 auto; /* Растягиваемся и сжимаемся */
        display: flex;
        flex-direction: column;
        padding: 0;
        position: relative;
        background: #0f172a;
        overflow: hidden; /* Скрываем скроллы родителя */
        height: 100%;     /* Важно! */
    }

    #modalTextarea {  /* Используем ID для максимального приоритета над Bootstrap/другими стилями */
        width: 100% !important;
        height: 100% !important;
        min-height: 100% !important;
        max-width: none !important; /* Убираем ограничения ширины */
        
        background: transparent;
        border: none;
        padding: 32px;
        color: #e2e8f0;
        font-family: 'JetBrains Mono', 'Fira Code', monospace;
        font-size: 16px;
        line-height: 1.7;
        resize: none; /* Запрещаем ручное изменение размера, так как у нас фуллскрин */
        outline: none;
        box-sizing: border-box; /* Чтобы padding не ломал ширину 100% */
        display: block;
    }

    .fullscreen-textarea {
        flex: 1;
        /* Force full width and override global styles */
        width: 100% !important; 
        max-width: 100% !important; 
        height: 100%;
        background: transparent;
        border: none;
        padding: 32px;
        color: #e2e8f0;
        font-family: 'JetBrains Mono', 'Fira Code', monospace;
        font-size: 16px;
        line-height: 1.7;
        resize: none;
        outline: none;
        box-sizing: border-box; /* Важно для отступов */
    }
    
    /* --- Knowledge Base Tab Styles --- */
    .kb-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .kb-item {
        display: flex;
        align-items: center;
        padding: 16px;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid var(--dash-border);
        border-radius: 16px;
        transition: all 0.2s;
    }
    
    .kb-item:hover {
        background: rgba(255, 255, 255, 0.04);
        border-color: rgba(255, 255, 255, 0.1);
        transform: translateX(4px);
    }

    .kb-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        margin-right: 20px;
    }
    
    .kb-icon.pdf { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
    .kb-icon.docx { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
    .kb-icon.txt { background: rgba(148, 163, 184, 0.1); color: #94a3b8; }

    /* --- Analytics Tab Styles --- */
    .analytics-grid-top {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 24px;
    }
    
    .kpi-card {
        background: var(--dash-surface);
        border: 1px solid var(--dash-border);
        border-radius: 16px;
        padding: 20px;
    }
    
    .chart-box-large {
        background: var(--dash-surface);
        border: 1px solid var(--dash-border);
        border-radius: 20px;
        padding: 24px;
        height: 400px;
        margin-bottom: 24px;
    }

    /* --- Conversation Tab Styles --- */
    .conv-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 8px;
    }
    
    .conv-row {
        background: rgba(255, 255, 255, 0.02);
        transition: background 0.2s;
    }
    
    .conv-row:hover { background: rgba(255, 255, 255, 0.04); }
    
    .conv-cell {
        padding: 16px;
        border-top: 1px solid var(--dash-border);
        border-bottom: 1px solid var(--dash-border);
    }
    
    .conv-cell:first-child {
        border-left: 1px solid var(--dash-border);
        border-top-left-radius: 12px;
        border-bottom-left-radius: 12px;
    }
    
    .conv-cell:last-child {
        border-right: 1px solid var(--dash-border);
        border-top-right-radius: 12px;
        border-bottom-right-radius: 12px;
    }


    /* Карточка RAG */
    .rag-card {
        background: linear-gradient(145deg, rgba(30, 41, 59, 0.4), rgba(15, 23, 42, 0.6));
        border: 1px solid var(--dash-border);
        border-radius: 16px;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 20px;
        margin-top: 24px;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .rag-card:hover {
        border-color: var(--dash-primary);
        box-shadow: 0 8px 24px -6px rgba(99, 102, 241, 0.25);
        transform: translateY(-2px);
    }
    
    /* Декоративная полоска слева */
    .rag-card::before {
        content: '';
        position: absolute;
        top: 0; left: 0; bottom: 0;
        width: 4px;
        background: var(--dash-primary);
        opacity: 0.7;
    }

    /* Иконка */
    .rag-icon {
        width: 48px;
        height: 48px;
        background: rgba(99, 102, 241, 0.1);
        color: var(--dash-primary);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        border: 1px solid rgba(99, 102, 241, 0.2);
        flex-shrink: 0;
    }

    .rag-content { flex: 1; }

    .rag-title {
        font-size: 15px;
        font-weight: 700;
        color: #fff;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .rag-desc {
        font-size: 13px;
        color: var(--dash-text-muted);
        line-height: 1.4;
    }

    .pro-badge {
        font-size: 10px; 
        background: rgba(99, 102, 241, 0.2); 
        color: #818cf8; 
        padding: 2px 6px; 
        border-radius: 4px;
        border: 1px solid rgba(99, 102, 241, 0.3);
    }

    /* Красивый свитчер */
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 52px;
        height: 28px;
        flex-shrink: 0;
    }
    
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    
    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: #334155;
        transition: .4s;
        border-radius: 34px;
        border: 1px solid rgba(255,255,255,0.1);
    }
    
    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    input:checked + .toggle-slider {
        background-color: var(--dash-primary);
        border-color: transparent;
        box-shadow: 0 0 10px rgba(99, 102, 241, 0.4);
    }
    
    input:checked + .toggle-slider:before {
        transform: translateX(24px);
    }
</style>
{% endblock %}

{% block content %}
<div class="bot-detail-container">

    <div class="bot-header-card">
        <div class="bot-header-bg-glow"></div>
        
        <div class="bot-avatar-xl">
            {% if bot.platform == 'telegram' %}
                <i class="fa-brands fa-telegram" style="color: #229ED9;"></i>
            {% elif bot.platform == 'whatsapp' %}
                <i class="fa-brands fa-whatsapp" style="color: #25D366;"></i>
            {% elif bot.platform == 'vk' %}
                <i class="fa-brands fa-vk" style="color: #0077FF;"></i>
            {% else %}
                <i class="fa-solid fa-robot"></i>
            {% endif %}
        </div>

        <div class="bot-header-info">
            <div class="bot-title-row">
                <div>
                    <h1>{{ bot.name }}</h1>
                    <div class="bot-badges">
                        <div class="status-badge {% if bot.status == 'active' %}active{% else %}inactive{% endif %}">
                            <i class="fa-solid fa-circle" style="font-size: 8px;"></i>
                            {% if bot.status == 'active' %}Активен{% else %}Остановлен{% endif %}
                        </div>
                        <span style="color: var(--dash-text-muted);">
                            <i class="fa-solid fa-microchip"></i> {{ bot.openai_model }}
                        </span>
                        <span style="color: var(--dash-text-muted);">
                            <i class="fa-solid fa-clock"></i> Создан {{ bot.created_at|date:"d.m.Y" }}
                        </span>
                    </div>
                </div>
                
                <div class="header-actions">
                     {% if bot.platform == 'telegram' %}
                        {% if bot.session_string %}
                        <a href="https://t.me/{{ bot.telegram_username }}" target="_blank" class="btn btn-primary" style="background: #229ED9; border-color: #229ED9;">
                            <i class="fa-brands fa-telegram"></i> Telegram
                        </a>
                        {% else %}
                        <a href="{% url 'telegram_connect' bot.id %}" class="btn btn-secondary">
                            <i class="fa-solid fa-link"></i> Подключить
                        </a>
                        {% endif %}
                    {% endif %}
                    
                    <button class="btn btn-secondary" onclick="toggleBotStatus()">
                        <i class="fa-solid fa-power-off"></i> 
                        {% if bot.status == 'active' %}Стоп{% else %}Пуск{% endif %}
                    </button>
                </div>
            </div>
            
            <p style="color: var(--dash-text-muted); font-size: 15px; margin: 0; max-width: 800px; line-height: 1.5;">
                {{ bot.description|default:"Нет описания. Добавьте его в настройках, чтобы лучше понимать назначение агента." }}
            </p>
        </div>
    </div>

    <div class="tabs-container">
        <div class="tabs-nav">
            <button class="tab-button active" onclick="switchTab('config')">
                <i class="fa-solid fa-sliders"></i> Настройки и AI
            </button>
            <button class="tab-button" onclick="switchTab('analytics')">
                <i class="fa-solid fa-chart-pie"></i> Аналитика
            </button>
            <button class="tab-button" onclick="switchTab('knowledge')">
                <i class="fa-solid fa-database"></i> База знаний
            </button>
            <button class="tab-button" onclick="switchTab('conversations')">
                <i class="fa-solid fa-comments"></i> Диалоги
            </button>
        </div>
    </div>

    <div id="tab-config" class="tab-content active">
        <form method="POST" action="{% url 'agent_detail' bot.id %}" id="botConfigForm">
            {% csrf_token %}
            
            <div class="config-grid">
                <div>
                    <div class="config-card" style="margin-bottom: 24px; border-color: rgba(99, 102, 241, 0.4);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; display: flex; align-items: center; gap: 12px;">
                                <i class="fa-solid fa-wand-magic-sparkles" style="color: var(--dash-primary);"></i>
                                Системный промпт
                            </h3>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="openEditor()">
                                <i class="fa-solid fa-expand"></i> Развернуть редактор
                            </button>
                        </div>

                        <textarea name="system_prompt" id="realPromptInput" style="display: none;">{{ bot.system_prompt }}</textarea>

                        <div class="prompt-preview-box" onclick="openEditor()">
                            <div class="prompt-preview-text" id="promptPreviewText">{{ bot.system_prompt }}</div>
                        </div>
                    </div>

                    <div class="config-card">
                        <h3 style="margin-top: 0;">Основная информация</h3>
                        
                        <div class="form-group">
                            <label class="form-label">Название агента</label>
                            <input type="text" name="name" class="form-input" value="{{ bot.name }}" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Описание</label>
                            <textarea name="description" class="form-textarea" rows="3">{{ bot.description }}</textarea>
                        </div>

                        <div class="rag-card">
                            <div class="rag-icon">
                                <i class="fa-solid fa-database"></i>
                            </div>
                            
                            <div class="rag-content">
                                <div class="rag-title">
                                    База Знаний (RAG)
                                    <span class="pro-badge">PRO</span>
                                </div>
                                <div class="rag-desc">
                                    Бот будет искать ответы в загруженных файлах перед генерацией ответа.
                                </div>
                            </div>

                            <label class="toggle-switch">
                                <input type="checkbox" name="use_rag" {% if bot.use_rag %}checked{% endif %}>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="config-card" style="height: auto;">
                        <h3 style="margin-top: 0;">Модель интеллекта</h3>
                        
                        <div class="form-group">
                            <label class="form-label">LLM Провайдер и Модель</label>
                            <select name="model" class="form-select" id="aiModelSelect" onchange="updateModelColor()">
                                <optgroup label="OpenAI" class="optgroup-openai">
                                    <option value="gpt-4o" {% if bot.openai_model == 'gpt-4o' %}selected{% endif %}>GPT-4o (Флагман)</option>
                                    <option value="gpt-4o-mini" {% if bot.openai_model == 'gpt-4o-mini' %}selected{% endif %}>GPT-4o Mini (Быстрая)</option>
                                    <option value="gpt-4-turbo" {% if bot.openai_model == 'gpt-4-turbo' %}selected{% endif %}>GPT-4 Turbo</option>
                                </optgroup>
                                
                                <optgroup label="Google DeepMind" class="optgroup-google">
                                    <option value="gemini-1.5-pro" {% if bot.openai_model == 'gemini-1.5-pro' %}selected{% endif %}>Gemini 1.5 Pro</option>
                                    <option value="gemini-1.5-flash" {% if bot.openai_model == 'gemini-1.5-flash' %}selected{% endif %}>Gemini 1.5 Flash</option>
                                </optgroup>
                                
                                <optgroup label="Anthropic" class="optgroup-anthropic">
                                    <option value="claude-3-5-sonnet" {% if bot.openai_model == 'claude-3-5-sonnet' %}selected{% endif %}>Claude 3.5 Sonnet</option>
                                    <option value="claude-3-opus" {% if bot.openai_model == 'claude-3-opus' %}selected{% endif %}>Claude 3 Opus</option>
                                </optgroup>
                            </select>
                            <div style="margin-top: 8px; font-size: 12px; color: var(--dash-text-muted);" id="modelHint"></div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Температура (Креативность)</label>
                            <div style="display: flex; align-items: center; gap: 16px;">
                                <input type="range" name="temperature" min="0" max="2" step="0.1" value="{{ bot.temperature|default:'0.7' }}" style="flex: 1;" oninput="tempDisplay.innerText = this.value">
                                <span id="tempDisplay" style="font-family: monospace; font-weight: bold; font-size: 16px; color: var(--dash-primary); width: 40px; text-align: right;">{{ bot.temperature|default:'0.7' }}</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Лимит токенов</label>
                            <input type="number" name="max_tokens" class="form-input" value="{{ bot.max_tokens|default:'1000' }}">
                        </div>

                        <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center; margin-top: 12px; height: 48px; font-size: 16px;">
                            <i class="fa-solid fa-floppy-disk"></i> Сохранить изменения
                        </button>
                    </div>

                    <div style="margin-top: 24px; border: 1px solid rgba(239, 68, 68, 0.3); background: rgba(239, 68, 68, 0.05); border-radius: 16px; padding: 20px;">
                        <h4 style="margin: 0 0 12px 0; color: #ef4444;">Опасная зона</h4>
                        <button type="button" class="btn btn-secondary" onclick="deleteBot()" style="width: 100%; border-color: #ef4444; color: #ef4444;">
                            <i class="fa-solid fa-trash"></i> Удалить агента
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <div id="tab-analytics" class="tab-content">
        <div class="analytics-grid-top">
            <div class="kpi-card">
                <div style="color: var(--dash-text-muted); font-size: 13px; margin-bottom: 8px;">Всего диалогов</div>
                <div style="font-size: 28px; font-weight: 800; color: #fff;">{{ bot.conversations_count }}</div>
                <div style="color: #4ade80; font-size: 12px; margin-top: 4px;">
                    <i class="fa-solid fa-arrow-up"></i> 12% за неделю
                </div>
            </div>
            
            <div class="kpi-card">
                <div style="color: var(--dash-text-muted); font-size: 13px; margin-bottom: 8px;">Всего сообщений</div>
                <div style="font-size: 28px; font-weight: 800; color: #fff;">{{ bot.total_messages|default:0 }}</div>
            </div>

            <div class="kpi-card">
                <div style="color: var(--dash-text-muted); font-size: 13px; margin-bottom: 8px;">Лиды</div>
                <div style="font-size: 28px; font-weight: 800; color: #fff;">{{ bot.leads_count }}</div>
                <div style="color: #4ade80; font-size: 12px; margin-top: 4px;">CR: 5.2%</div>
            </div>

            <div class="kpi-card">
                <div style="color: var(--dash-text-muted); font-size: 13px; margin-bottom: 8px;">База знаний</div>
                <div style="font-size: 28px; font-weight: 800; color: #fff;">{{ bot.knowledge_count }} <span style="font-size: 14px; font-weight: normal; color: var(--dash-text-muted);">файлов</span></div>
            </div>
        </div>

        <div class="chart-box-large">
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <h3 style="margin: 0;">Активность диалогов</h3>
                <select class="form-select" style="width: 150px; padding: 6px 12px;" id="chartPeriod" onchange="loadChart()">
                    <option value="7days">7 дней</option>
                    <option value="30days">30 дней</option>
                </select>
            </div>
            <div style="height: 300px; width: 100%;">
                <canvas id="analyticsChart"></canvas>
            </div>
        </div>
    </div>

    <div id="tab-knowledge" class="tab-content">
        <div class="config-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h3 style="margin: 0;">Файлы базы знаний</h3>
                <a href="{% url 'upload_knowledge' %}?bot_id={{ bot.id }}" class="btn btn-primary">
                    <i class="fa-solid fa-cloud-arrow-up"></i> Загрузить файл
                </a>
            </div>

            {% if knowledge_files %}
                <div class="kb-list">
                    {% for file in knowledge_files %}
                    <div class="kb-item">
                        <div class="kb-icon {{ file.file_type }}">
                            {% if file.file_type == 'pdf' %}<i class="fa-solid fa-file-pdf"></i>
                            {% elif file.file_type == 'docx' %}<i class="fa-solid fa-file-word"></i>
                            {% else %}<i class="fa-solid fa-file-lines"></i>{% endif %}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">{{ file.title }}</div>
                            <div style="font-size: 12px; color: var(--dash-text-muted);">
                                {{ file.file_size_display }} • {{ file.created_at|date:"d M Y, H:i" }}
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 16px;">
                            {% if file.is_indexed %}
                                <span class="status-badge active"><i class="fa-solid fa-check"></i> Индекс</span>
                            {% else %}
                                <span class="status-badge inactive"><i class="fa-solid fa-clock"></i> Обработка</span>
                            {% endif %}
                            
                            <a href="{% url 'knowledge_detail' file.id %}" class="btn btn-secondary btn-sm">
                                <i class="fa-solid fa-eye"></i>
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <div style="margin-top: 24px; text-align: center;">
                    <a href="{% url 'bot_knowledge_base' bot.id %}" class="btn btn-secondary">
                        Посмотреть все файлы ({{ bot.knowledge_count }})
                    </a>
                </div>
            {% else %}
                <div style="text-align: center; padding: 60px;">
                    <i class="fa-solid fa-folder-open" style="font-size: 48px; color: var(--dash-border); margin-bottom: 20px;"></i>
                    <h4 style="margin: 0 0 8px 0;">База знаний пуста</h4>
                    <p style="color: var(--dash-text-muted); margin-bottom: 24px;">Загрузите документы, чтобы бот мог отвечать на вопросы ваших клиентов.</p>
                    <a href="{% url 'upload_knowledge' %}?bot_id={{ bot.id }}" class="btn btn-primary">Загрузить первый файл</a>
                </div>
            {% endif %}
        </div>
    </div>

    <div id="tab-conversations" class="tab-content">
        <div class="config-card" style="padding: 0; overflow: hidden;">
            <div style="padding: 24px; border-bottom: 1px solid var(--dash-border); display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0;">История диалогов</h3>
                <a href="{% url 'conversations_list' %}?bot={{ bot.id }}" class="btn btn-secondary btn-sm">Вся история</a>
            </div>

            {% if recent_conversations %}
            <table class="conv-table">
                <tbody>
                    {% for conv in recent_conversations %}
                    <tr class="conv-row">
                        <td class="conv-cell" style="width: 60px; padding-right: 0;">
                            <div style="width: 40px; height: 40px; background: rgba(99, 102, 241, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--dash-primary);">
                                <i class="fa-solid fa-user"></i>
                            </div>
                        </td>
                        <td class="conv-cell">
                            <div style="font-weight: 600; margin-bottom: 4px;">{{ conv.user_name|default:conv.user_id }}</div>
                            <div style="font-size: 13px; color: var(--dash-text-muted);">
                                {% if conv.is_lead %}
                                    <span style="color: #4ade80; margin-right: 8px;"><i class="fa-solid fa-bullseye"></i> Лид</span>
                                {% endif %}
                                {{ conv.last_message|truncatechars:60|default:"Нет сообщений" }}
                            </div>
                        </td>
                        <td class="conv-cell" style="text-align: right; white-space: nowrap; color: var(--dash-text-muted); font-size: 13px;">
                            {{ conv.last_message_at|timesince }} назад
                        </td>
                        <td class="conv-cell" style="width: 60px;">
                            <a href="{% url 'conversation_detail' conv.id %}" class="btn-icon">
                                <i class="fa-solid fa-chevron-right"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
                <div style="padding: 40px; text-align: center; color: var(--dash-text-muted);">
                    Диалогов пока нет. Подключите бота к мессенджеру и напишите ему.
                </div>
            {% endif %}
        </div>
    </div>

</div>

<div class="modal-overlay" id="editorModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="margin: 0; color: #fff; font-size: 20px;">
                <i class="fa-solid fa-code"></i> Редактор системного промпта
            </h3>
            <div style="display: flex; gap: 12px;">
                <button type="button" class="btn btn-secondary" onclick="closeEditor()">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="saveEditor()">
                    <i class="fa-solid fa-check"></i> Применить
                </button>
            </div>
        </div>
        <div class="modal-body">
            <textarea id="modalTextarea" class="fullscreen-textarea" spellcheck="false" placeholder="Введите инструкции для AI здесь...">{{ bot.system_prompt }}</textarea>
        </div>
        <div style="padding: 12px 32px; background: #0f172a; border-top: 1px solid var(--dash-border); font-size: 13px; color: var(--dash-text-muted); display: flex; justify-content: space-between;">
            <span>Используйте Markdown для форматирования.</span>
            <span>{{ bot.name }} • {{ bot.openai_model }}</span>
        </div>
    </div>
</div>

<script>
    const csrfToken = '{{ csrf_token }}';
    const botId = {{ bot.id }};

    const modal = document.getElementById('editorModal');
    const textarea = document.getElementById('modalTextarea');
    const realInput = document.getElementById('realPromptInput');
    const preview = document.getElementById('promptPreviewText');

    function openEditor() {
        document.body.appendChild(modal);
        
        textarea.value = realInput.value;
        
        modal.classList.add('open');
        document.body.style.overflow = 'hidden';
        textarea.focus();
    }

    function closeEditor() {
        modal.classList.remove('open');
        document.body.style.overflow = '';
    }

    function saveEditor() {
        const val = textarea.value;
        realInput.value = val;
        preview.innerText = val;
        closeEditor();
    }

    // Закрытие по ESC
    document.addEventListener('keydown', function(event) {
        if (event.key === "Escape" && modal.classList.contains('open')) {
            closeEditor();
        }
    });

    // --- Tabs Logic ---
    function switchTab(tabId) {
        // Hide all
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
        
        // Show target
        document.getElementById('tab-' + tabId).classList.add('active');
        event.currentTarget.classList.add('active');

        // Если открыли аналитику, рендерим чарт (если еще не рендерили или нужно обновить)
        if (tabId === 'analytics') {
            loadChart();
        }
    }

    // --- Model Color & Hint ---
    function updateModelColor() {
        const select = document.getElementById('aiModelSelect');
        const selectedOpt = select.options[select.selectedIndex];
        const group = selectedOpt.parentElement.className;
        const hint = document.getElementById('modelHint');

        select.style.borderColor = 'var(--dash-border)';
        hint.style.color = 'var(--dash-text-muted)';

        if (group.includes('openai')) {
            select.style.borderColor = 'var(--provider-openai)';
            hint.innerText = "OpenAI: Идеальный баланс. GPT-4o рекомендуется для сложных задач.";
            hint.style.color = 'var(--provider-openai)';
        } else if (group.includes('google')) {
            select.style.borderColor = 'var(--provider-google)';
            hint.innerText = "Google: Огромное контекстное окно. Отлично для анализа больших документов.";
            hint.style.color = 'var(--provider-google)';
        } else if (group.includes('anthropic')) {
            select.style.borderColor = 'var(--provider-anthropic)';
            hint.innerText = "Anthropic: Человечные ответы и высокий уровень безопасности.";
            hint.style.color = 'var(--provider-anthropic)';
        }
    }
    updateModelColor(); // Init

    // --- Bot Actions ---
    async function toggleBotStatus() {
        if(!confirm('Вы уверены, что хотите переключить статус бота?')) return;
        try {
            const res = await fetch(`/api/agents/${botId}/toggle/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken }
            });
            if (res.ok) location.reload();
        } catch(e) { alert('Ошибка сети'); }
    }

    async function deleteBot() {
        const check = prompt(`Введите "${'{{ bot.name|escapejs }}'}" чтобы подтвердить удаление:`);
        if (check === '{{ bot.name|escapejs }}') {
             try {
                const res = await fetch(`/api/agents/${botId}/delete/`, {
                    method: 'DELETE',
                    headers: { 'X-CSRFToken': csrfToken }
                });
                if (res.ok) window.location.href = "{% url 'agents_list' %}";
            } catch(e) { alert('Ошибка сети'); }
        }
    }

    // --- Analytics Chart (Simple Init) ---
    let chartInstance = null;
    async function loadChart() {
        const ctx = document.getElementById('analyticsChart');
        if(!ctx) return;
        
        // Здесь мы просто заглушку данных ставим, 
        // в реальности нужно делать fetch на /api/analytics/chart/conversations/
        
        if(chartInstance) return; // Don't re-init just for tab switch demo

        const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 300);
        gradient.addColorStop(0, 'rgba(99, 102, 241, 0.4)');
        gradient.addColorStop(1, 'rgba(99, 102, 241, 0)');

        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'],
                datasets: [{
                    label: 'Диалоги',
                    data: [12, 19, 3, 5, 2, 3, 10], // Пример данных
                    borderColor: '#6366f1',
                    backgroundColor: gradient,
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#1e293b',
                    pointBorderColor: '#6366f1',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { 
                        grid: { color: 'rgba(255,255,255,0.05)' },
                        ticks: { color: '#94a3b8' }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: '#94a3b8' }
                    }
                }
            }
        });
    }

</script>
{% endblock %}