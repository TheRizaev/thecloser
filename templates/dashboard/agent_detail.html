{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}{{ bot.name }} — Детали бота{% endblock %}

{% block extra_css %}
<style>
.bot-detail-container {
    max-width: 1400px;
    margin: 0 auto;
}

/* Header Card */
.bot-header-card {
    background: var(--dash-surface);
    border: 1px solid var(--dash-border);
    border-radius: 20px;
    padding: 32px;
    margin-bottom: 32px;
    display: flex;
    align-items: center;
    gap: 24px;
}

.bot-avatar-xl {
    width: 100px;
    height: 100px;
    background: rgba(99, 102, 241, 0.1);
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 40px;
    flex-shrink: 0;
}

.bot-header-info {
    flex: 1;
}

.bot-header-info h1 {
    font-size: 32px;
    margin: 0 0 8px 0;
}

.bot-status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 14px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 12px;
}

.bot-status-badge.active {
    background: rgba(34, 197, 94, 0.1);
    color: #22c55e;
    border: 1px solid rgba(34, 197, 94, 0.2);
}

.bot-status-badge.inactive {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.2);
}

.bot-meta-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 16px;
    margin-top: 12px;
}

.bot-meta-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: var(--dash-text-muted);
}

.bot-header-actions {
    display: flex;
    gap: 12px;
    flex-direction: column;
}

/* Stats Grid */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin-bottom: 32px;
}

.stat-card {
    background: var(--dash-surface);
    border: 1px solid var(--dash-border);
    border-radius: 16px;
    padding: 24px;
    transition: transform 0.2s;
}

.stat-card:hover {
    transform: translateY(-2px);
}

.stat-icon {
    width: 56px;
    height: 56px;
    background: rgba(99, 102, 241, 0.1);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 16px;
    font-size: 24px;
    color: var(--dash-primary);
}

.stat-value {
    font-size: 36px;
    font-weight: 700;
    margin-bottom: 6px;
}

.stat-label {
    font-size: 13px;
    color: var(--dash-text-muted);
}

/* Tabs */
.tabs-nav {
    display: flex;
    gap: 8px;
    margin-bottom: 24px;
    padding: 8px;
    background: var(--dash-surface);
    border: 1px solid var(--dash-border);
    border-radius: 16px;
    overflow-x: auto;
}

.tab-button {
    padding: 12px 24px;
    border: none;
    background: transparent;
    color: var(--dash-text-muted);
    font-size: 14px;
    font-weight: 500;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 8px;
}

.tab-button:hover {
    background: rgba(255, 255, 255, 0.05);
    color: var(--dash-text);
}

.tab-button.active {
    background: var(--dash-primary);
    color: white;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

/* Configuration Tab */
.config-section {
    background: var(--dash-surface);
    border: 1px solid var(--dash-border);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 20px;
}

.config-section h3 {
    margin: 0 0 20px 0;
    font-size: 18px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--dash-text);
}

.form-input, .form-textarea, .form-select {
    width: 100%;
    background: rgba(15, 23, 42, 0.6);
    border: 1px solid var(--dash-border);
    border-radius: 10px;
    padding: 12px 16px;
    color: var(--dash-text);
    font-size: 14px;
    font-family: inherit;
}

.form-textarea {
    resize: vertical;
    min-height: 100px;
}

.form-input:focus, .form-textarea:focus, .form-select:focus {
    outline: none;
    border-color: var(--dash-primary);
}

.form-hint {
    font-size: 12px;
    color: var(--dash-text-muted);
    margin-top: 6px;
}

.toggle-switch {
    position: relative;
    display: inline-block;
    width: 52px;
    height: 28px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(255, 255, 255, 0.1);
    transition: .3s;
    border-radius: 28px;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .3s;
    border-radius: 50%;
}

input:checked + .toggle-slider {
    background-color: var(--dash-primary);
}

input:checked + .toggle-slider:before {
    transform: translateX(24px);
}

/* Knowledge Base Tab */
.kb-stats-mini {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

.kb-stat-mini {
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid var(--dash-border);
    border-radius: 12px;
    padding: 16px;
}

.kb-stat-value {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 4px;
}

.kb-stat-label {
    font-size: 12px;
    color: var(--dash-text-muted);
}

.kb-files-preview {
    display: grid;
    gap: 12px;
}

.kb-file-mini {
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid var(--dash-border);
    border-radius: 12px;
    padding: 16px;
    display: flex;
    align-items: center;
    gap: 16px;
    transition: all 0.2s;
}

.kb-file-mini:hover {
    border-color: rgba(99, 102, 241, 0.3);
}

.kb-file-icon-mini {
    width: 44px;
    height: 44px;
    background: rgba(99, 102, 241, 0.1);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
}

.kb-file-icon-mini.pdf { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
.kb-file-icon-mini.docx { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
.kb-file-icon-mini.txt { background: rgba(168, 85, 247, 0.1); color: #a855f7; }
.kb-file-icon-mini.md { background: rgba(34, 197, 94, 0.1); color: #22c55e; }

/* Conversations Tab */
.conversations-list {
    display: grid;
    gap: 12px;
}

.conversation-mini {
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid var(--dash-border);
    border-radius: 12px;
    padding: 16px;
    display: flex;
    align-items: center;
    gap: 16px;
    transition: all 0.2s;
    cursor: pointer;
}

.conversation-mini:hover {
    border-color: rgba(99, 102, 241, 0.3);
    transform: translateX(4px);
}

.conversation-avatar {
    width: 48px;
    height: 48px;
    background: rgba(99, 102, 241, 0.1);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    flex-shrink: 0;
}

.conversation-info {
    flex: 1;
    min-width: 0;
}

.conversation-user {
    font-weight: 600;
    margin-bottom: 4px;
}

.conversation-last-msg {
    font-size: 13px;
    color: var(--dash-text-muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.conversation-meta {
    font-size: 12px;
    color: var(--dash-text-muted);
    text-align: right;
}

/* Analytics Tab */
.chart-container {
    background: var(--dash-surface);
    border: 1px solid var(--dash-border);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 20px;
    height: 300px;
}

/* Empty States */
.empty-state {
    text-align: center;
    padding: 60px 20px;
}

.empty-state .empty-icon {
    width: 100px;
    height: 100px;
    background: rgba(99, 102, 241, 0.1);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px;
    font-size: 40px;
    color: var(--dash-primary);
}

.empty-state h3 {
    margin: 0 0 8px 0;
    font-size: 18px;
}

.empty-state p {
    color: var(--dash-text-muted);
    margin: 0 0 20px 0;
}

/* Danger Zone */
.danger-zone {
    background: rgba(239, 68, 68, 0.05);
    border: 1px solid rgba(239, 68, 68, 0.2);
    border-radius: 16px;
    padding: 24px;
    margin-top: 32px;
}

.danger-zone h3 {
    color: var(--dash-error);
    margin: 0 0 12px 0;
    font-size: 16px;
}

.danger-zone p {
    color: var(--dash-text-muted);
    margin: 0 0 16px 0;
    font-size: 14px;
}
</style>
{% endblock %}

{% block content %}
<div class="bot-detail-container">
    <!-- Bot Header -->
    <div class="bot-header-card">
        <div class="bot-avatar-xl">
            {% if bot.platform == 'telegram' %}
                <i class="fa-brands fa-telegram" style="color: #229ED9;"></i>
            {% elif bot.platform == 'whatsapp' %}
                <i class="fa-brands fa-whatsapp" style="color: #25D366;"></i>
            {% elif bot.platform == 'vk' %}
                <i class="fa-brands fa-vk" style="color: #0077FF;"></i>
            {% elif bot.platform == 'instagram' %}
                <i class="fa-brands fa-instagram" style="color: #E4405F;"></i>
            {% else %}
                <i class="fa-solid fa-robot"></i>
            {% endif %}
        </div>
        
        <div class="bot-header-info">
            <h1>{{ bot.name }}</h1>
            
            <div class="bot-status-badge {% if bot.status == 'active' %}active{% else %}inactive{% endif %}">
                <i class="fa-solid fa-circle" style="font-size: 8px;"></i>
                {% if bot.status == 'active' %}Активен{% else %}Неактивен{% endif %}
            </div>
            
            <div class="bot-meta-grid">
                <div class="bot-meta-item">
                    <i class="fa-solid fa-layer-group"></i>
                    <span>{{ bot.get_platform_display }}</span>
                </div>
                <div class="bot-meta-item">
                    <i class="fa-solid fa-calendar"></i>
                    <span>Создан {{ bot.created_at|date:"d.m.Y" }}</span>
                </div>
                {% if bot.platform == 'telegram' and bot.session_string %}
                <div class="bot-meta-item">
                    <i class="fa-solid fa-link"></i>
                    <span>Подключен к Telegram</span>
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="bot-header-actions">
            {% if bot.platform == 'telegram' %}
                {% if bot.session_string %}
                <a href="https://t.me/{{ bot.telegram_username }}" target="_blank" class="btn btn-primary" style="background: #229ED9; border-color: #229ED9;">
                    <i class="fa-brands fa-telegram"></i>
                    Открыть в Telegram
                </a>
                {% else %}
                <a href="{% url 'telegram_connect' bot.id %}" class="btn btn-secondary">
                    <i class="fa-brands fa-telegram"></i>
                    Подключить Telegram
                </a>
                {% endif %}
            {% endif %}
            
            <button class="btn btn-secondary" onclick="toggleBotStatus()">
                <i class="fa-solid fa-power-off"></i>
                {% if bot.status == 'active' %}Отключить{% else %}Включить{% endif %}
            </button>
            
            <a href="{% url 'agents_list' %}" class="btn btn-secondary">
                <i class="fa-solid fa-arrow-left"></i>
                Назад к списку
            </a>
        </div>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fa-solid fa-comments"></i>
            </div>
            <div class="stat-value">{{ bot.conversations_count|default:0 }}</div>
            <div class="stat-label">Всего диалогов</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(34, 197, 94, 0.1); color: #22c55e;">
                <i class="fa-solid fa-message"></i>
            </div>
            <div class="stat-value">{{ bot.leads_count|default:0 }}</div>
            <div class="stat-label">Лидов захвачено</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(168, 85, 247, 0.1); color: #a855f7;">
                <i class="fa-solid fa-brain"></i>
            </div>
            <div class="stat-value">{{ bot.knowledge_count|default:0 }}</div>
            <div class="stat-label">Файлов знаний</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                <i class="fa-solid fa-clock"></i>
            </div>
            <div class="stat-value">&lt;1с</div>
            <div class="stat-label">Среднее время ответа</div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs-nav">
        <button class="tab-button active" onclick="switchTab('overview')">
            <i class="fa-solid fa-chart-line"></i>
            Обзор
        </button>
        <button class="tab-button" onclick="switchTab('config')">
            <i class="fa-solid fa-gear"></i>
            Настройки
        </button>
        <button class="tab-button" onclick="switchTab('knowledge')">
            <i class="fa-solid fa-brain"></i>
            База знаний
        </button>
        <button class="tab-button" onclick="switchTab('conversations')">
            <i class="fa-solid fa-comments"></i>
            Диалоги
        </button>
        <button class="tab-button" onclick="switchTab('analytics')">
            <i class="fa-solid fa-chart-pie"></i>
            Аналитика
        </button>
    </div>

    <!-- Tab: Overview -->
    <div id="tab-overview" class="tab-content active">
        <div class="glass-card">
            <h3 style="margin: 0 0 20px 0;">
                <i class="fa-solid fa-info-circle"></i>
                О боте
            </h3>
            
            <div style="display: grid; gap: 20px;">
                <div>
                    <div class="form-label">Описание</div>
                    <p style="color: var(--dash-text-muted); margin: 0;">
                        {{ bot.description|default:"Описание не указано" }}
                    </p>
                </div>
                
                <div>
                    <div class="form-label">Системный промпт</div>
                    <div style="background: rgba(255, 255, 255, 0.02); border: 1px solid var(--dash-border); border-radius: 10px; padding: 16px;">
                        <pre style="margin: 0; white-space: pre-wrap; font-size: 13px; color: var(--dash-text-muted);">{{ bot.system_prompt|truncatewords:50 }}</pre>
                    </div>
                </div>
                
                <div>
                    <div class="form-label">Модель AI</div>
                    <p style="color: var(--dash-text-muted); margin: 0;">
                        {{ bot.openai_model|default:"gpt-4o-mini" }}
                    </p>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="glass-card" style="margin-top: 20px;">
            <h3 style="margin: 0 0 20px 0;">
                <i class="fa-solid fa-clock-rotate-left"></i>
                Последняя активность
            </h3>
            
            {% if recent_conversations %}
            <div class="conversations-list">
                {% for conv in recent_conversations|slice:":5" %}
                <a href="{% url 'conversation_detail' conv.id %}" class="conversation-mini" style="text-decoration: none; color: inherit;">
                    <div class="conversation-avatar">
                        <i class="fa-solid fa-user"></i>
                    </div>
                    <div class="conversation-info">
                        <div class="conversation-user">{{ conv.user_name|default:"Пользователь" }}</div>
                        <div class="conversation-last-msg">{{ conv.last_message|truncatewords:10 }}</div>
                    </div>
                    <div class="conversation-meta">
                        {{ conv.updated_at|timesince }} назад
                    </div>
                </a>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state" style="padding: 40px 20px;">
                <p style="color: var(--dash-text-muted);">Пока нет активных диалогов</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Tab: Configuration -->
    <div id="tab-config" class="tab-content">
        <form method="POST" action="{% url 'agent_detail' bot.id %}">
            {% csrf_token %}
            
            <!-- Basic Settings -->
            <div class="config-section">
                <h3>
                    <i class="fa-solid fa-sliders"></i>
                    Основные настройки
                </h3>
                
                <div class="form-group">
                    <label class="form-label">Название бота *</label>
                    <input type="text" name="name" class="form-input" value="{{ bot.name }}" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Описание</label>
                    <textarea name="description" class="form-textarea">{{ bot.description }}</textarea>
                    <div class="form-hint">Краткое описание назначения бота</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Платформа</label>
                    <select name="platform" class="form-select" disabled>
                        <option value="telegram" {% if bot.platform == 'telegram' %}selected{% endif %}>Telegram</option>
                        <option value="whatsapp" {% if bot.platform == 'whatsapp' %}selected{% endif %}>WhatsApp</option>
                        <option value="vk" {% if bot.platform == 'vk' %}selected{% endif %}>ВКонтакте</option>
                        <option value="instagram" {% if bot.platform == 'instagram' %}selected{% endif %}>Instagram</option>
                    </select>
                    <div class="form-hint">Платформу нельзя изменить после создания</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" style="display: flex; align-items: center; gap: 12px;">
                        <span>Статус бота</span>
                        <label class="toggle-switch">
                            <input type="checkbox" name="is_active" {% if bot.status == 'active' %}checked{% endif %}>
                            <span class="toggle-slider"></span>
                        </label>
                    </label>
                    <div class="form-hint">Включить или отключить бота</div>
                </div>
            </div>

            <!-- AI Settings -->
            <div class="config-section">
                <h3>
                    <i class="fa-solid fa-brain"></i>
                    Настройки AI
                </h3>
                
                <div class="form-group">
                    <label class="form-label">Модель AI</label>
                    <select name="model" class="form-select">
                        <option value="gpt-3.5-turbo" {% if bot.openai_model == 'gpt-3.5-turbo' %}selected{% endif %}>GPT-3.5 Turbo</option>
                        <option value="gpt-4" {% if bot.openai_model == 'gpt-4' %}selected{% endif %}>GPT-4</option>
                        <option value="gpt-4-turbo" {% if bot.openai_model == 'gpt-4-turbo' %}selected{% endif %}>GPT-4 Turbo</option>
                        <option value="gpt-4o-mini" {% if bot.openai_model == 'gpt-4o-mini' %}selected{% endif %}>GPT-4o Mini</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Системный промпт *</label>
                    <textarea name="system_prompt" class="form-textarea" rows="8" required>{{ bot.system_prompt }}</textarea>
                    <div class="form-hint">Инструкции для AI о том, как отвечать на вопросы</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Температура ({{ bot.temperature|default:"0.7" }})</label>
                    <input type="range" name="temperature" min="0" max="2" step="0.1" value="{{ bot.temperature|default:'0.7' }}" class="form-input" style="padding: 0;">
                    <div class="form-hint">Креативность ответов: 0 = точные, 2 = креативные</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Максимум токенов в ответе</label>
                    <input type="number" name="max_tokens" class="form-input" value="{{ bot.max_tokens|default:'1000' }}" min="100" max="4000">
                    <div class="form-hint">Максимальная длина ответа бота</div>
                </div>
            </div>

            <!-- RAG Settings -->
            <div class="config-section">
                <h3>
                    <i class="fa-solid fa-database"></i>
                    Настройки RAG (база знаний)
                </h3>
                
                <div class="form-group">
                    <label class="form-label" style="display: flex; align-items: center; gap: 12px;">
                        <span>Использовать базу знаний</span>
                        <label class="toggle-switch">
                            <input type="checkbox" name="use_rag" {% if bot.use_rag %}checked{% endif %}>
                            <span class="toggle-slider"></span>
                        </label>
                    </label>
                    <div class="form-hint">Искать ответы в загруженных документах</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Количество фрагментов для поиска</label>
                    <input type="number" name="rag_k" class="form-input" value="{{ bot.rag_top_k|default:'3' }}" min="1" max="10">
                    <div class="form-hint">Сколько релевантных фрагментов искать (1-10)</div>
                </div>
            </div>

            <!-- Save Button -->
            <div style="display: flex; gap: 12px;">
                <button type="submit" class="btn btn-primary" style="flex: 1;">
                    <i class="fa-solid fa-save"></i>
                    Сохранить изменения
                </button>
                <button type="reset" class="btn btn-secondary">
                    Отменить
                </button>
            </div>
        </form>

        <!-- Danger Zone -->
        <div class="danger-zone">
            <h3><i class="fa-solid fa-triangle-exclamation"></i> Опасная зона</h3>
            <p>Удаление бота нельзя отменить. Все данные, диалоги и настройки будут удалены навсегда.</p>
            <button class="btn btn-secondary" onclick="deleteBot()" style="background: var(--dash-error); border-color: var(--dash-error); color: white;">
                <i class="fa-solid fa-trash"></i>
                Удалить бота
            </button>
        </div>
    </div>

    <!-- Tab: Knowledge Base -->
    <div id="tab-knowledge" class="tab-content">
        <div class="glass-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h3 style="margin: 0;">
                    <i class="fa-solid fa-brain"></i>
                    База знаний бота
                </h3>
                <div style="display: flex; gap: 12px;">
                    <a href="{% url 'upload_knowledge' %}?bot_id={{ bot.id }}" class="btn btn-primary">
                        <i class="fa-solid fa-upload"></i>
                        Загрузить файл
                    </a>
                    <a href="{% url 'bot_knowledge_base' bot.id %}" class="btn btn-secondary">
                        <i class="fa-solid fa-folder-open"></i>
                        Открыть полностью
                    </a>
                </div>
            </div>

            <!-- KB Stats -->
            <div class="kb-stats-mini">
                <div class="kb-stat-mini">
                    <div class="kb-stat-value">{{ bot.knowledge_count|default:0 }}</div>
                    <div class="kb-stat-label">Файлов</div>
                </div>
                
                <div class="kb-stat-mini">
                    <div class="kb-stat-value">0</div>
                    <div class="kb-stat-label">Фрагментов</div>
                </div>
                
                <div class="kb-stat-mini">
                    <div class="kb-stat-value">0</div>
                    <div class="kb-stat-label">Проиндексировано</div>
                </div>
            </div>

            <!-- Files Preview -->
            {% if knowledge_files %}
            <div class="kb-files-preview">
                {% for file in knowledge_files|slice:":5" %}
                <div class="kb-file-mini">
                    <div class="kb-file-icon-mini {{ file.file_type }}">
                        {% if file.file_type == 'pdf' %}
                            <i class="fa-solid fa-file-pdf"></i>
                        {% elif file.file_type == 'docx' %}
                            <i class="fa-solid fa-file-word"></i>
                        {% elif file.file_type == 'txt' %}
                            <i class="fa-solid fa-file-lines"></i>
                        {% elif file.file_type == 'md' %}
                            <i class="fa-brands fa-markdown"></i>
                        {% else %}
                            <i class="fa-solid fa-file"></i>
                        {% endif %}
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-weight: 600; margin-bottom: 4px;">{{ file.title }}</div>
                        <div style="font-size: 12px; color: var(--dash-text-muted);">
                            {{ file.file_size_display }} • {{ file.chunks_count }} фрагментов
                        </div>
                    </div>
                    <a href="{% url 'knowledge_detail' file.id %}" class="btn-icon">
                        <i class="fa-solid fa-arrow-right"></i>
                    </a>
                </div>
                {% endfor %}
                
                {% if bot.knowledge_count > 5 %}
                <div style="text-align: center; padding: 16px;">
                    <a href="{% url 'bot_knowledge_base' bot.id %}" class="btn btn-secondary">
                        Показать все {{ bot.knowledge_count }} файлов
                    </a>
                </div>
                {% endif %}
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fa-solid fa-book"></i>
                </div>
                <h3>База знаний пуста</h3>
                <p>Загрузите документы, чтобы бот мог отвечать на вопросы на основе ваших данных</p>
                <a href="{% url 'upload_knowledge' %}?bot_id={{ bot.id }}" class="btn btn-primary">
                    <i class="fa-solid fa-upload"></i>
                    Загрузить первый файл
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Tab: Conversations -->
    <div id="tab-conversations" class="tab-content">
        <div class="glass-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h3 style="margin: 0;">
                    <i class="fa-solid fa-comments"></i>
                    Диалоги с ботом
                </h3>
                <a href="{% url 'conversations_list' %}?bot={{ bot.id }}" class="btn btn-secondary">
                    Все диалоги
                </a>
            </div>

            {% if recent_conversations %}
            <div class="conversations-list">
                {% for conv in recent_conversations %}
                <a href="{% url 'conversation_detail' conv.id %}" class="conversation-mini" style="text-decoration: none; color: inherit;">
                    <div class="conversation-avatar">
                        <i class="fa-solid fa-user"></i>
                    </div>
                    <div class="conversation-info">
                        <div class="conversation-user">
                            {{ conv.user_name|default:"Пользователь" }}
                            <span style="font-size: 12px; color: var(--dash-text-muted); font-weight: normal;">
                                • {{ conv.messages_count }} сообщений
                            </span>
                        </div>
                        <div class="conversation-last-msg">{{ conv.last_message|truncatewords:15 }}</div>
                    </div>
                    <div class="conversation-meta">
                        <div style="margin-bottom: 4px;">{{ conv.updated_at|date:"d.m.Y" }}</div>
                        <div>{{ conv.updated_at|time:"H:i" }}</div>
                    </div>
                </a>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="fa-solid fa-comments"></i>
                </div>
                <h3>Пока нет диалогов</h3>
                <p>Диалоги появятся, когда пользователи начнут общаться с ботом</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Tab: Analytics -->
    <div id="tab-analytics" class="tab-content">
        <div class="glass-card">
            <h3 style="margin: 0 0 24px 0;">
                <i class="fa-solid fa-chart-line"></i>
                Статистика использования
            </h3>

            <!-- Charts -->
            <div class="chart-container">
                <canvas id="messagesChart"></canvas>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                <div style="background: rgba(255, 255, 255, 0.02); border: 1px solid var(--dash-border); border-radius: 12px; padding: 20px;">
                    <div class="form-label">Всего диалогов</div>
                    <div style="font-size: 32px; font-weight: 700;">{{ bot.conversations_count|default:0 }}</div>
                </div>
                
                <div style="background: rgba(255, 255, 255, 0.02); border: 1px solid var(--dash-border); border-radius: 12px; padding: 20px;">
                    <div class="form-label">Всего сообщений</div>
                    <div style="font-size: 32px; font-weight: 700;">0</div>
                </div>
                
                <div style="background: rgba(255, 255, 255, 0.02); border: 1px solid var(--dash-border); border-radius: 12px; padding: 20px;">
                    <div class="form-label">Среднее время ответа</div>
                    <div style="font-size: 32px; font-weight: 700;">&lt;1с</div>
                </div>
                
                <div style="background: rgba(255, 255, 255, 0.02); border: 1px solid var(--dash-border); border-radius: 12px; padding: 20px;">
                    <div class="form-label">Активных сегодня</div>
                    <div style="font-size: 32px; font-weight: 700;">0</div>
                </div>
            </div>

            <div style="text-align: center; margin-top: 32px;">
                <a href="{% url 'analytics' %}?bot={{ bot.id }}" class="btn btn-secondary">
                    <i class="fa-solid fa-chart-bar"></i>
                    Подробная аналитика
                </a>
            </div>
        </div>
    </div>
</div>

<script>
const csrfToken = '{{ csrf_token }}';
const botId = {{ bot.id }};

// Tab Switching
function switchTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active from all buttons
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById('tab-' + tabName).classList.add('active');
    
    // Activate button
    event.target.closest('.tab-button').classList.add('active');
}

// Toggle Bot Status
async function toggleBotStatus() {
    const currentStatus = '{{ bot.status }}';
    const newStatus = currentStatus === 'active' ? 'paused' : 'active';
    
    if (!confirm(`${currentStatus === 'active' ? 'Отключить' : 'Включить'} бота?`)) return;
    
    try {
        const response = await fetch(`/api/agents/${botId}/toggle/`, {
            method: 'POST',
            headers: { 
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: newStatus })
        });
        
        if (response.ok) {
            location.reload();
        } else {
            alert('Ошибка изменения статуса');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Ошибка: ' + error);
    }
}

// Delete Bot
async function deleteBot() {
    const confirmation = prompt(
        'Введите "УДАЛИТЬ" для подтверждения удаления бота "{{ bot.name|escapejs }}":'
    );
    
    if (confirmation !== 'УДАЛИТЬ') {
        alert('Удаление отменено');
        return;
    }
    
    try {
        const response = await fetch(`/api/agents/${botId}/delete/`, {
            method: 'DELETE',
            headers: { 'X-CSRFToken': csrfToken }
        });
        
        if (response.ok) {
            window.location.href = '{% url "agents_list" %}';
        } else {
            alert('Ошибка удаления');
        }
    } catch (error) {
        alert('Ошибка: ' + error);
    }
}

// Initialize Chart (if Chart.js is loaded)
if (typeof Chart !== 'undefined') {
    const ctx = document.getElementById('messagesChart');
    if (ctx) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Сообщения',
                    data: [],
                    borderColor: 'rgb(99, 102, 241)',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
}
</script>
{% endblock %}