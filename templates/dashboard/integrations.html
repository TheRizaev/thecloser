{% extends 'dashboard/base.html' %}

{% block title %}Интеграции — CRM{% endblock %}

{% block extra_css %}
<style>
    /* ============================================
       GLOBAL & HEADER
       ============================================ */
    :root {
        --card-bg: rgba(30, 41, 59, 0.6);
        --card-border: rgba(255, 255, 255, 0.08);
        --primary-glow: rgba(99, 102, 241, 0.5);
    }

    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 40px;
        position: relative;
    }

    /* Фоновое свечение */
    .dashboard-header::before {
        content: '';
        position: absolute;
        top: -50px;
        left: -50px;
        width: 300px;
        height: 300px;
        background: radial-gradient(circle, rgba(99, 102, 241, 0.15) 0%, transparent 70%);
        pointer-events: none;
        z-index: -1;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .header-icon-box {
        width: 64px;
        height: 64px;
        background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9));
        border: 1px solid var(--card-border);
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        color: #818cf8;
        box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.3);
    }

    .page-title {
        font-size: 2rem;
        font-weight: 800;
        margin: 0;
        background: linear-gradient(to right, #fff, #94a3b8);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        line-height: 1.2;
    }

    .page-subtitle {
        color: #64748b;
        font-size: 1rem;
        margin-top: 4px;
    }

    /* ============================================
       GRID & CARDS
       ============================================ */
    .integrations-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
        gap: 24px;
        margin-bottom: 60px;
    }

    .integration-card {
        background: var(--card-bg);
        backdrop-filter: blur(12px);
        border: 1px solid var(--card-border);
        border-radius: 24px;
        padding: 32px;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .integration-card:hover {
        transform: translateY(-5px);
        background: rgba(30, 41, 59, 0.8);
        border-color: rgba(99, 102, 241, 0.3);
        box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.4);
    }

    .integration-card.connected {
        border-color: rgba(34, 197, 94, 0.3);
        background: linear-gradient(to bottom, rgba(34, 197, 94, 0.05), rgba(30, 41, 59, 0.6));
    }

    /* Logo Styling */
    .logo-wrapper {
        width: 80px;
        height: 80px;
        border-radius: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 36px;
        margin-bottom: 20px;
        position: relative;
        z-index: 1;
        box-shadow: 0 15px 30px -10px rgba(0,0,0,0.3);
    }

    .logo-wrapper::after {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: 22px;
        border: 1px solid rgba(255,255,255,0.1);
        pointer-events: none;
    }

    .logo-wrapper.amocrm { background: linear-gradient(135deg, #4c8bf5, #2b5cbf); color: #fff; } 
    .logo-wrapper.gcalendar { background: linear-gradient(135deg, #4285F4, #34A853); color: #fff; }
    .logo-wrapper.gsheets { background: linear-gradient(135deg, #10b981, #059669); color: #fff; }

    .card-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #fff;
        margin-bottom: 8px;
    }

    .card-desc {
        font-size: 0.9rem;
        color: #94a3b8;
        margin-bottom: 24px;
        line-height: 1.5;
        height: 40px;
    }

    /* Status Indicators */
    .connection-status {
        position: absolute;
        top: 20px;
        right: 20px;
    }

    .status-dot-pulse {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        position: relative;
    }

    .status-dot-pulse.active { background: #4ade80; box-shadow: 0 0 10px rgba(74, 222, 128, 0.5); }
    .status-dot-pulse.inactive { background: #475569; }

    /* Action Button */
    .btn-action-card {
        width: 100%;
        padding: 14px;
        border-radius: 14px;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid transparent;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .btn-action-card.connect {
        background: rgba(255, 255, 255, 0.05);
        color: #fff;
        border-color: rgba(255, 255, 255, 0.1);
    }

    .btn-action-card.connect:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: #fff;
    }

    .btn-action-card.manage {
        background: rgba(34, 197, 94, 0.1);
        color: #4ade80;
        border-color: rgba(34, 197, 94, 0.2);
    }

    .btn-action-card.manage:hover {
        background: rgba(34, 197, 94, 0.2);
    }

    /* ============================================
       MODAL STYLES
       ============================================ */
    .modal-overlay {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(8px);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }

    .modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .modal-window {
        background: #1e293b;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 24px;
        width: 100%;
        max-width: 550px;
        padding: 32px;
        position: relative;
        transform: scale(0.95);
        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-overlay.active .modal-window {
        transform: scale(1);
    }

    .modal-close {
        position: absolute;
        top: 24px;
        right: 24px;
        background: transparent;
        border: none;
        color: #64748b;
        font-size: 20px;
        cursor: pointer;
        transition: color 0.2s;
    }

    .modal-close:hover { color: #fff; }

    .modal-header { text-align: center; margin-bottom: 30px; }
    .modal-logo {
        width: 56px; height: 56px; border-radius: 16px;
        display: inline-flex; align-items: center; justify-content: center;
        font-size: 24px; margin-bottom: 16px; color: #fff;
    }
    .modal-title { font-size: 1.5rem; font-weight: 700; margin: 0; color: #fff; }

    /* Form Elements inside Modal */
    .form-input-group { margin-bottom: 20px; text-align: left; }
    
    .form-input-group label {
        display: block;
        font-size: 0.9rem;
        font-weight: 600;
        color: #cbd5e1;
        margin-bottom: 8px;
    }

    .form-input {
        width: 100%;
        padding: 14px 16px;
        background: #0f172a;
        border: 1px solid #334155;
        border-radius: 12px;
        color: #fff;
        font-size: 0.95rem;
        transition: border-color 0.2s;
    }

    .form-input:focus {
        outline: none;
        border-color: #818cf8;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
    }

    .input-hint {
        font-size: 0.8rem;
        color: #64748b;
        margin-top: 6px;
    }

    .btn-modal-submit {
        width: 100%;
        padding: 16px;
        background: linear-gradient(135deg, #6366f1, #4f46e5);
        color: white;
        border: none;
        border-radius: 14px;
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
        transition: transform 0.2s;
        margin-top: 10px;
    }

    .btn-modal-submit:hover { transform: translateY(-2px); }
    .btn-modal-submit:active { transform: translateY(0); }

    .btn-modal-disconnect {
        width: 100%;
        padding: 16px;
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.2);
        border-radius: 14px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 16px;
    }

    .btn-modal-disconnect:hover { background: rgba(239, 68, 68, 0.2); }

    /* Tabs in Modal */
    .modal-tabs {
        display: flex;
        background: #0f172a;
        padding: 4px;
        border-radius: 12px;
        margin-bottom: 24px;
    }

    .modal-tab {
        flex: 1;
        padding: 10px;
        background: transparent;
        border: none;
        color: #64748b;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.2s;
    }

    .modal-tab.active {
        background: #334155;
        color: #fff;
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.3s; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* Messages */
    .message-box {
        padding: 12px; border-radius: 10px; margin-bottom: 20px; font-size: 0.9rem; display: flex; align-items: center; gap: 10px;
    }
    .message-box.error { background: rgba(239, 68, 68, 0.1); color: #fca5a5; }
    .message-box.success { background: rgba(34, 197, 94, 0.1); color: #86efac; }

    /* Coming Soon */
    .soon-section {
        border-top: 1px solid var(--card-border);
        padding-top: 40px;
        text-align: center;
    }
    .soon-tags {
        display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 20px;
    }
    .soon-tag {
        padding: 8px 16px; background: rgba(255,255,255,0.03); border-radius: 100px;
        border: 1px solid rgba(255,255,255,0.05); color: #94a3b8; font-size: 0.9rem;
        display: flex; align-items: center; gap: 8px;
    }

    @media (max-width: 600px) {
        .dashboard-header { flex-direction: column; align-items: flex-start; gap: 10px; }
        .integrations-grid { grid-template-columns: 1fr; }
        .modal-window { padding: 20px; }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-header">
    <div class="header-left">
        <div class="header-icon-box">
            <i class="fa-solid fa-plug"></i>
        </div>
        <div>
            <h1 class="page-title">Интеграции</h1>
            <p class="page-subtitle">Подключите CRM для автоматического сбора лидов</p>
        </div>
    </div>
</div>

<div class="integrations-grid">
    <div class="integration-card {% if amocrm and amocrm.is_connected %}connected{% endif %}">
        <div class="connection-status">
            <div class="status-dot-pulse {% if amocrm and amocrm.is_connected %}active{% else %}inactive{% endif %}"></div>
        </div>
        
        <div class="logo-wrapper amocrm">
            <i class="fa-solid fa-a"></i>
        </div>
        
        <h3 class="card-title">AmoCRM</h3>
        <p class="card-desc">Полная синхронизация сделок и воронок продаж.</p>
        
        {% if amocrm and amocrm.is_connected %}
            <button class="btn-action-card manage" onclick="openModal('amocrm')">
                <i class="fa-solid fa-gear"></i> Настроить
            </button>
        {% else %}
            <button class="btn-action-card connect" onclick="openModal('amocrm')">
                <i class="fa-solid fa-link"></i> Подключить
            </button>
        {% endif %}
    </div>

    <div class="integration-card {% if google_calendar and google_calendar.is_connected %}connected{% endif %}">
        <div class="connection-status">
            <div class="status-dot-pulse {% if google_calendar and google_calendar.is_connected %}active{% else %}inactive{% endif %}"></div>
        </div>
        
        <div class="logo-wrapper gcalendar">
            <i class="fa-solid fa-calendar-days"></i>
        </div>
        
        <h3 class="card-title">Google Calendar</h3>
        <p class="card-desc">Планирование встреч и проверка занятости слотов.</p>
        
        {% if google_calendar and google_calendar.is_connected %}
            <button class="btn-action-card manage" onclick="openModal('gcalendar')">
                <i class="fa-solid fa-gear"></i> Настроить
            </button>
        {% else %}
            <button class="btn-action-card connect" onclick="openModal('gcalendar')">
                <i class="fa-solid fa-link"></i> Подключить
            </button>
        {% endif %}
    </div>

    <div class="integration-card {% if google_sheets and google_sheets.is_connected %}connected{% endif %}">
        <div class="connection-status">
            <div class="status-dot-pulse {% if google_sheets and google_sheets.is_connected %}active{% else %}inactive{% endif %}"></div>
        </div>
        
        <div class="logo-wrapper gsheets">
            <i class="fa-solid fa-table"></i>
        </div>
        
        <h3 class="card-title">Google Sheets</h3>
        <p class="card-desc">Выгрузка лидов в таблицу в реальном времени.</p>
        
        {% if google_sheets and google_sheets.is_connected %}
            <button class="btn-action-card manage" onclick="openModal('gsheets')">
                <i class="fa-solid fa-gear"></i> Настроить
            </button>
        {% else %}
            <button class="btn-action-card connect" onclick="openModal('gsheets')">
                <i class="fa-solid fa-link"></i> Подключить
            </button>
        {% endif %}
    </div>
</div>

<div class="soon-section">
    <h4 style="color: #64748b; font-weight: 500;">Скоро появятся</h4>
    <div class="soon-tags">
        <span class="soon-tag"><i class="fa-brands fa-bitbucket"></i> Bitrix24</span>
        <span class="soon-tag"><i class="fa-brands fa-slack"></i> Slack</span>
        <span class="soon-tag"><i class="fa-solid fa-envelope"></i> Email</span>
        <span class="soon-tag"><i class="fa-brands fa-trello"></i> Trello</span>
    </div>
</div>

<div class="modal-overlay" id="modal-amocrm">
    <div class="modal-window">
        <button class="modal-close" onclick="closeModal('amocrm')">&times;</button>
        <div class="modal-header">
            <div class="modal-logo" style="background: linear-gradient(135deg, #4c8bf5, #2b5cbf);">
                <i class="fa-solid fa-a"></i>
            </div>
            <h2 class="modal-title">Настройка AmoCRM</h2>
        </div>

        <div id="amocrm-status-msg" class="message-box success" style="display: {% if amocrm.is_connected %}flex{% else %}none{% endif %};">
            <i class="fa-solid fa-check"></i> <span>Подключено: {{ amocrm.domain }}</span>
        </div>
        <div id="amocrm-error" class="message-box error" style="display: none;"></div>

        <div style="text-align: center; padding: 20px 0;">
            <p style="color: #cbd5e1; margin-bottom: 24px; line-height: 1.6;">
                Для подключения перейдите на страницу авторизации AmoCRM и предоставьте доступ приложению.
            </p>
            <button class="btn-modal-submit" onclick="connectAmoCRM()" id="amocrm-connect-btn">
                {% if amocrm.is_connected %}Обновить подключение{% else %}Войти через AmoCRM{% endif %}
            </button>
        </div>

        {% if amocrm.is_connected %}
        <button class="btn-modal-disconnect" onclick="disconnectAmoCRM()">Отключить</button>
        {% endif %}
    </div>
</div>

<div class="modal-overlay" id="modal-gcalendar">
    <div class="modal-window">
        <button class="modal-close" onclick="closeModal('gcalendar')">&times;</button>
        <div class="modal-header">
            <div class="modal-logo" style="background: linear-gradient(135deg, #4285F4, #34A853);">
                <i class="fa-solid fa-calendar-days"></i>
            </div>
            <h2 class="modal-title">Google Calendar</h2>
        </div>

        <div id="gcalendar-status-msg" class="message-box success" style="display: {% if google_calendar.is_connected %}flex{% else %}none{% endif %};">
            <i class="fa-solid fa-check"></i> <span>Подключено: {{ google_calendar.calendar_id }}</span>
        </div>
        <div id="gcalendar-error" class="message-box error" style="display: none;"></div>

        <div class="modal-tabs">
            <button class="modal-tab active" onclick="switchTab(this, 'gc-oauth')">OAuth 2.0</button>
            <button class="modal-tab" onclick="switchTab(this, 'gc-service')">Service Account</button>
        </div>

        <div id="gc-oauth" class="tab-content active">
            <div class="form-input-group">
                <label>Calendar ID</label>
                <input type="text" id="gcalendar-id-oauth" class="form-input" placeholder="primary" value="primary">
            </div>
            <div class="form-input-group" style="text-align: center; margin-top: 20px;">
                <button class="btn-modal-submit" style="background: #fff; color: #333; display: flex; align-items: center; justify-content: center; gap: 10px;" onclick="connectGCalendar()">
                    <img src="https://www.svgrepo.com/show/475656/google-color.svg" width="20" alt="G"> Войти через Google
                </button>
            </div>
        </div>

        <div id="gc-service" class="tab-content">
            <div class="form-input-group">
                <label>Calendar ID (например: example@group.calendar.google.com)</label>
                <input type="text" id="gcalendar-id-service" class="form-input" placeholder="Calendar ID">
            </div>
            <div class="form-input-group">
                <label>JSON Ключ Service Account</label>
                <textarea id="gcalendar-credentials" class="form-input" rows="4" placeholder="{...}"></textarea>
            </div>
        </div>

        <button class="btn-modal-submit" onclick="connectGCalendar()" id="gcalendar-connect-btn">
            {% if google_calendar.is_connected %}Обновить{% else %}Подключить{% endif %}
        </button>

        {% if google_calendar.is_connected %}
        <button class="btn-modal-disconnect" onclick="disconnectGCalendar()">Отключить</button>
        {% endif %}
    </div>
</div>

<div class="modal-overlay" id="modal-gsheets">
    <div class="modal-window">
        <button class="modal-close" onclick="closeModal('gsheets')">&times;</button>
        <div class="modal-header">
            <div class="modal-logo" style="background: linear-gradient(135deg, #10b981, #059669);">
                <i class="fa-solid fa-table"></i>
            </div>
            <h2 class="modal-title">Google Sheets</h2>
        </div>

        <div id="gsheets-status-msg" class="message-box success" style="display: {% if google_sheets.is_connected %}flex{% else %}none{% endif %};">
            <i class="fa-solid fa-check"></i> <span>Подключено: {{ google_sheets.sheet_name }}</span>
        </div>
        <div id="gsheets-error" class="message-box error" style="display: none;"></div>

        <div class="modal-tabs">
            <button class="modal-tab active" onclick="switchTab(this, 'gs-simple')">URL</button>
            <button class="modal-tab" onclick="switchTab(this, 'gs-service')">Service Account</button>
        </div>

        <div id="gs-simple" class="tab-content active">
            <div class="form-input-group">
                <label>Ссылка на таблицу</label>
                <input type="text" id="gsheets-url" class="form-input" placeholder="https://docs.google.com/...">
                <p class="input-hint">Таблица должна быть открыта для доступа по ссылке.</p>
            </div>
        </div>

        <div id="gs-service" class="tab-content">
            <div class="form-input-group">
                <label>ID Таблицы</label>
                <input type="text" id="gsheets-spreadsheet-id" class="form-input" placeholder="ID из URL">
            </div>
            <div class="form-input-group">
                <label>JSON Ключ</label>
                <textarea id="gsheets-credentials" class="form-input" rows="4" placeholder="{...}"></textarea>
            </div>
        </div>

        <button class="btn-modal-submit" onclick="connectGSheets()" id="gsheets-connect-btn">
            {% if google_sheets.is_connected %}Обновить{% else %}Подключить{% endif %}
        </button>

        {% if google_sheets.is_connected %}
        <div style="margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button class="btn-modal-submit" style="background: #334155; margin-top:0;" onclick="testGSheets()">Тест</button>
            <a href="https://docs.google.com/spreadsheets/d/{% if google_sheets %}{{ google_sheets.spreadsheet_id }}{% endif %}" target="_blank" class="btn-modal-submit" style="background: #334155; margin-top:0; text-align:center; text-decoration:none; display:block;">Открыть</a>
        </div>
        <button class="btn-modal-disconnect" onclick="disconnectGSheets()">Отключить</button>
        {% endif %}
    </div>
</div>

<script>
const csrfToken = '{{ csrf_token }}';
let currentGCalendarMethod = 'oauth';
let currentGSheetsMethod = 'simple';

// =======================
// UI FUNCTIONS
// =======================

function openModal(type) {
    document.getElementById(`modal-${type}`).classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeModal(type) {
    document.getElementById(`modal-${type}`).classList.remove('active');
    document.body.style.overflow = '';
}

function switchTab(btn, tabId) {
    const parent = btn.closest('.modal-window');
    parent.querySelectorAll('.modal-tab').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    parent.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');

    if(tabId.includes('gc')) currentGCalendarMethod = tabId.includes('oauth') ? 'oauth' : 'service';
    if(tabId.includes('gs')) currentGSheetsMethod = tabId.includes('simple') ? 'simple' : 'service';
}

function showUIError(crm, msg) {
    const div = document.getElementById(`${crm}-error`);
    div.style.display = 'flex';
    div.innerHTML = `<i class="fa-solid fa-circle-exclamation"></i> <span>${msg}</span>`;
}

function clearUIMessages(crm) {
    document.getElementById(`${crm}-error`).style.display = 'none';
}

// =======================
// AMOCRM LOGIC (OAuth Only)
// =======================
function connectAmoCRM() {
    const btn = document.getElementById('amocrm-connect-btn');
    clearUIMessages('amocrm');
    
    // Redirect to backend endpoint for OAuth initiation
    window.location.href = "/dashboard/integrations/api/amocrm/connect/";
}

async function disconnectAmoCRM() {
    if(!confirm('Отключить AmoCRM?')) return;
    try {
        const res = await fetch('/dashboard/integrations/api/amocrm/disconnect/', {
            method: 'POST', headers: {'X-CSRFToken': csrfToken}
        });
        if(res.ok) location.reload();
    } catch(e) { alert('Ошибка сети'); }
}

// =======================
// GOOGLE CALENDAR LOGIC
// =======================
async function connectGCalendar() {
    const btn = document.getElementById('gcalendar-connect-btn');
    clearUIMessages('gcalendar');
    btn.disabled = true; btn.innerText = 'Подключение...';

    let body, url;
    if(currentGCalendarMethod === 'oauth') {
        alert("OAuth 2.0 интеграция будет доступна в следующем обновлении");
        btn.disabled = false; btn.innerText = 'Подключить';
        return;
    } else {
        url = '/dashboard/integrations/api/google-calendar/connect/';
        body = {
            calendar_id: document.getElementById('gcalendar-id-service').value,
            credentials_json: document.getElementById('gcalendar-credentials').value
        };
    }

    try {
        // Mock connection for now
        alert("Интеграция с Google Calendar находится в разработке!");
    } catch(e) {
        showUIError('gcalendar', 'Ошибка сети');
    } finally {
        btn.disabled = false; btn.innerText = 'Подключить';
    }
}

async function disconnectGCalendar() {
    if(!confirm('Отключить Google Calendar?')) return;
    try {
        const res = await fetch('/dashboard/integrations/api/google-calendar/disconnect/', {
            method: 'POST', headers: {'X-CSRFToken': csrfToken}
        });
        if(res.ok) location.reload();
    } catch(e) { alert('Ошибка сети'); }
}

// =======================
// GSHEETS LOGIC
// =======================
async function connectGSheets() {
    const btn = document.getElementById('gsheets-connect-btn');
    clearUIMessages('gsheets');
    btn.disabled = true; btn.innerText = 'Подключение...';

    let body, url;
    if(currentGSheetsMethod === 'simple') {
        url = '/dashboard/integrations/api/google-sheets/connect-simple/';
        body = { spreadsheet_url: document.getElementById('gsheets-url').value };
    } else {
        url = '/dashboard/integrations/api/google-sheets/connect/';
        body = {
            spreadsheet_id: document.getElementById('gsheets-spreadsheet-id').value,
            credentials_json: document.getElementById('gsheets-credentials').value
        };
    }

    try {
        const res = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
            body: JSON.stringify(body)
        });
        const data = await res.json();
        if(data.success) location.reload();
        else showUIError('gsheets', data.error);
    } catch(e) {
        showUIError('gsheets', 'Ошибка сети');
    } finally {
        btn.disabled = false; btn.innerText = 'Подключить';
    }
}

async function disconnectGSheets() {
    if(!confirm('Отключить Google Sheets?')) return;
    try {
        const res = await fetch('/dashboard/integrations/api/google-sheets/disconnect/', {
            method: 'POST', headers: {'X-CSRFToken': csrfToken}
        });
        if(res.ok) location.reload();
    } catch(e) { alert('Ошибка сети'); }
}

async function testGSheets() {
    alert('Тест подключения...');
}

// Close modals on outside click
document.querySelectorAll('.modal-overlay').forEach(overlay => {
    overlay.addEventListener('click', (e) => {
        if(e.target === overlay) {
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }
    });
});
</script>
{% endblock %}