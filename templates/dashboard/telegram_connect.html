{% extends 'dashboard/base.html' %}

{% block title %}–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Telegram{% endblock %}

{% block extra_css %}
<style>
.auth-wizard {
    max-width: 600px;
    margin: 0 auto;
}

.wizard-step {
    display: none;
}

.wizard-step.active {
    display: block;
    animation: fadeIn 0.3s;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.step-indicator {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 40px;
}

.step-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}

.step-dot {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid var(--dash-border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    transition: all 0.3s;
}

.step-dot.active {
    background: var(--dash-primary);
    border-color: var(--dash-primary);
    color: white;
}

.step-dot.completed {
    background: var(--dash-success);
    border-color: var(--dash-success);
}

.step-label {
    font-size: 12px;
    color: var(--dash-text-muted);
    text-align: center;
}

.step-item.active .step-label {
    color: var(--dash-primary);
    font-weight: 600;
}

.info-box {
    background: rgba(99, 102, 241, 0.1);
    border: 1px solid rgba(99, 102, 241, 0.2);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 24px;
}

.info-box h4 {
    margin: 0 0 8px 0;
    color: var(--dash-primary);
    font-size: 14px;
    font-weight: 600;
}

.info-box p {
    margin: 0;
    font-size: 13px;
    color: var(--dash-text-muted);
    line-height: 1.5;
}

.info-box ol {
    margin: 12px 0 0 20px;
    padding: 0;
    font-size: 13px;
    color: var(--dash-text-muted);
    line-height: 1.8;
}

.info-box a {
    color: var(--dash-primary);
    text-decoration: none;
}

.info-box a:hover {
    text-decoration: underline;
}
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">üì± –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Telegram</h1>
        <p class="page-subtitle">{{ bot.name }}</p>
    </div>
</div>

<div class="glass-card auth-wizard">
    <!-- Step Indicator -->
    <div class="step-indicator">
        <div class="step-item active">
            <div class="step-dot active" id="step-dot-1">1</div>
            <div class="step-label">API –∫–ª—é—á–∏</div>
        </div>
        <div class="step-item">
            <div class="step-dot" id="step-dot-2">2</div>
            <div class="step-label">–ù–æ–º–µ—Ä</div>
        </div>
        <div class="step-item">
            <div class="step-dot" id="step-dot-3">3</div>
            <div class="step-label">–ö–æ–¥</div>
        </div>
        <div class="step-item">
            <div class="step-dot" id="step-dot-4">4</div>
            <div class="step-label">2FA</div>
        </div>
    </div>

    <!-- Step 1: API Credentials -->
    <div class="wizard-step active" id="step-1">
        <h2 style="text-align: center; margin-bottom: 20px;">–ü–æ–ª—É—á–∏—Ç–µ API –∫–ª—é—á–∏</h2>
        
        <div class="info-box">
            <h4><i class="fa-solid fa-circle-info"></i> –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å API ID –∏ API Hash?</h4>
            <ol>
                <li>–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ <a href="https://my.telegram.org" target="_blank">my.telegram.org</a></li>
                <li>–í–æ–π–¥–∏—Ç–µ —Å –ø–æ–º–æ—â—å—é –≤–∞—à–µ–≥–æ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞</li>
                <li>–ù–∞–∂–º–∏—Ç–µ "API development tools"</li>
                <li>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É (–º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –ª—é–±—ã–µ –¥–∞–Ω–Ω—ã–µ)</li>
                <li>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ <strong>api_id</strong> –∏ <strong>api_hash</strong></li>
            </ol>
        </div>

        <div class="form-group">
            <label class="form-label">API ID</label>
            <input 
                type="number" 
                id="api-id-input" 
                class="form-input" 
                placeholder="12345678"
                value="{{ bot.api_id }}"
            >
        </div>

        <div class="form-group">
            <label class="form-label">API Hash</label>
            <input 
                type="text" 
                id="api-hash-input" 
                class="form-input" 
                placeholder="abcdef1234567890abcdef1234567890"
                value="{{ bot.api_hash }}"
            >
        </div>

        <div id="api-error" style="display: none; color: var(--dash-error); margin-bottom: 20px; font-size: 14px;"></div>

        <button onclick="saveApiCredentials()" class="btn btn-primary" style="width: 100%;" id="api-save-btn">
            <i class="fa-solid fa-arrow-right"></i>
            –î–∞–ª–µ–µ
        </button>
    </div>

    <!-- Step 2: Phone Number -->
    <div class="wizard-step" id="step-2">
        <h2 style="text-align: center; margin-bottom: 30px;">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</h2>
        
        <div class="info-box">
            <h4><i class="fa-solid fa-circle-info"></i> –í–∞–∂–Ω–æ</h4>
            <p>–£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ —Å –∫–æ–¥–æ–º —Å—Ç—Ä–∞–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: +998901234567)</p>
        </div>

        <div class="form-group">
            <label class="form-label">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
            <input 
                type="tel" 
                id="phone-input" 
                class="form-input" 
                placeholder="+998901234567"
                autocomplete="tel"
                value="{{ bot.phone_number }}"
            >
        </div>

        <div id="error-message" style="display: none; color: var(--dash-error); margin-bottom: 20px; font-size: 14px;"></div>

        <button onclick="sendCode()" class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" id="send-code-btn">
            <i class="fa-solid fa-paper-plane"></i>
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥
        </button>

        <button onclick="goToStep(1)" class="btn btn-secondary" style="width: 100%;">
            <i class="fa-solid fa-arrow-left"></i>
            –ù–∞–∑–∞–¥
        </button>
    </div>

    <!-- Step 3: Verification Code -->
    <div class="wizard-step" id="step-3">
        <h2 style="text-align: center; margin-bottom: 30px;">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ Telegram</h2>
        
        <div class="info-box">
            <h4><i class="fa-solid fa-circle-info"></i> –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Telegram</h4>
            <p>–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram –Ω–∞ –Ω–æ–º–µ—Ä <strong id="phone-display"></strong></p>
        </div>

        <div class="form-group">
            <label class="form-label">–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</label>
            <input 
                type="text" 
                id="code-input" 
                class="form-input" 
                placeholder="12345"
                maxlength="5"
                autocomplete="one-time-code"
                style="text-align: center; font-size: 24px; letter-spacing: 8px;"
            >
        </div>

        <div id="verify-error" style="display: none; color: var(--dash-error); margin-bottom: 20px; font-size: 14px;"></div>

        <button onclick="verifyCode()" class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" id="verify-btn">
            <i class="fa-solid fa-check"></i>
            –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
        </button>

        <button onclick="goToStep(2)" class="btn btn-secondary" style="width: 100%;">
            <i class="fa-solid fa-arrow-left"></i>
            –ù–∞–∑–∞–¥
        </button>
    </div>

    <!-- Step 4: 2FA Password -->
    <div class="wizard-step" id="step-4">
        <h2 style="text-align: center; margin-bottom: 30px;">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å 2FA</h2>
        
        <div class="info-box">
            <h4><i class="fa-solid fa-shield-halved"></i> –î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</h4>
            <p>–£ –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –≤–∫–ª—é—á–µ–Ω–∞ 2FA. –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ –∏–ª–∏ –æ–±–ª–∞—á–Ω—ã–π –ø–∞—Ä–æ–ª—å Telegram.</p>
        </div>

        <div class="form-group">
            <label class="form-label">–ü–∞—Ä–æ–ª—å 2FA</label>
            <input 
                type="password" 
                id="password-input" 
                class="form-input" 
                placeholder="–í–∞—à –ø–∞—Ä–æ–ª—å 2FA"
                autocomplete="off"
                style="text-align: center; font-size: 18px;"
            >
        </div>

        <div id="password-error" style="display: none; color: var(--dash-error); margin-bottom: 20px; font-size: 14px;"></div>

        <button onclick="verifyWithPassword()" class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" id="password-btn">
            <i class="fa-solid fa-lock"></i>
            –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
        </button>

        <button onclick="goToStep(3)" class="btn btn-secondary" style="width: 100%;">
            <i class="fa-solid fa-arrow-left"></i>
            –ù–∞–∑–∞–¥
        </button>
    </div>

    <!-- Success Step -->
    <div class="wizard-step" id="step-success">
        <div style="text-align: center; padding: 40px 20px;">
            <div style="width: 80px; height: 80px; background: rgba(34, 197, 94, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px;">
                <i class="fa-solid fa-check" style="font-size: 40px; color: var(--dash-success);"></i>
            </div>
            <h2 style="margin-bottom: 12px;">–£—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ!</h2>
            <p style="color: var(--dash-text-muted); margin-bottom: 32px;">
                –í–∞—à Telegram –±–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ
            </p>
            <a href="{% url 'agent_detail' bot.id %}" class="btn btn-primary">
                <i class="fa-solid fa-arrow-right"></i>
                –ü–µ—Ä–µ–π—Ç–∏ –∫ –±–æ—Ç—É
            </a>
        </div>
    </div>
</div>

<script>
const botId = {{ bot.id }};
let currentStep = 1;
let requires2FA = false;

function goToStep(step) {
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ
    document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.step-dot').forEach(d => {
        d.classList.remove('active');
        d.classList.remove('completed');
    });
    document.querySelectorAll('.step-item').forEach(i => i.classList.remove('active'));
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ü–µ–ª–µ–≤–æ–π —à–∞–≥
    document.getElementById(`step-${step}`).classList.add('active');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —à–∞–≥ <= 4)
    if (step <= 4) {
        document.getElementById(`step-dot-${step}`).classList.add('active');
        document.querySelectorAll('.step-item')[step - 1].classList.add('active');
    }
    
    // –û—Ç–º–µ—á–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —à–∞–≥–∏ –∫–∞–∫ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ
    for (let i = 1; i < step && i <= 4; i++) {
        document.getElementById(`step-dot-${i}`).classList.add('completed');
    }
    
    currentStep = step;
}

function saveApiCredentials() {
    const apiId = document.getElementById('api-id-input').value.trim();
    const apiHash = document.getElementById('api-hash-input').value.trim();
    const errorDiv = document.getElementById('api-error');
    const btn = document.getElementById('api-save-btn');
    
    if (!apiId || !apiHash) {
        errorDiv.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±–∞ –ø–æ–ª—è';
        errorDiv.style.display = 'block';
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
    errorDiv.style.display = 'none';
    
    fetch(`/api/agents/${botId}/telegram/save-credentials/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ 
            api_id: apiId,
            api_hash: apiHash
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            goToStep(2);
        } else {
            errorDiv.textContent = data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è';
            errorDiv.style.display = 'block';
        }
    })
    .catch(error => {
        errorDiv.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
        errorDiv.style.display = 'block';
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fa-solid fa-arrow-right"></i> –î–∞–ª–µ–µ';
    });
}

function sendCode() {
    const phone = document.getElementById('phone-input').value.trim();
    const errorDiv = document.getElementById('error-message');
    const btn = document.getElementById('send-code-btn');
    
    if (!phone) {
        errorDiv.textContent = '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞';
        errorDiv.style.display = 'block';
        return;
    }
    
    // Validate phone format
    if (!phone.startsWith('+')) {
        errorDiv.textContent = '–ù–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å + –∏ –∫–æ–¥–∞ —Å—Ç—Ä–∞–Ω—ã';
        errorDiv.style.display = 'block';
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> –û—Ç–ø—Ä–∞–≤–∫–∞...';
    errorDiv.style.display = 'none';
    
    fetch(`/api/agents/${botId}/telegram/send-code/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ phone_number: phone })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('phone-display').textContent = phone;
            goToStep(3);
            // Focus on code input
            setTimeout(() => {
                document.getElementById('code-input').focus();
            }, 300);
        } else {
            errorDiv.textContent = data.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞';
            errorDiv.style.display = 'block';
        }
    })
    .catch(error => {
        errorDiv.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
        errorDiv.style.display = 'block';
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥';
    });
}

function verifyCode() {
    const code = document.getElementById('code-input').value.trim();
    const errorDiv = document.getElementById('verify-error');
    const btn = document.getElementById('verify-btn');
    
    if (!code) {
        errorDiv.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥';
        errorDiv.style.display = 'block';
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> –ü—Ä–æ–≤–µ—Ä–∫–∞...';
    errorDiv.style.display = 'none';
    
    fetch(`/api/agents/${botId}/telegram/verify-code/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ code: code })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
            document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
            document.getElementById('step-success').classList.add('active');
            document.querySelectorAll('.step-dot').forEach(d => d.classList.add('completed'));
        } else if (data.requires_2fa) {
            // –¢—Ä–µ–±—É–µ—Ç—Å—è 2FA - –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —à–∞–≥ 4
            requires2FA = true;
            goToStep(4);
            setTimeout(() => {
                document.getElementById('password-input').focus();
            }, 300);
        } else {
            errorDiv.textContent = data.error || '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥';
            errorDiv.style.display = 'block';
        }
    })
    .catch(error => {
        errorDiv.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
        errorDiv.style.display = 'block';
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fa-solid fa-check"></i> –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å';
    });
}

function verifyWithPassword() {
    const code = document.getElementById('code-input').value.trim(); // –ö–æ–¥ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —à–∞–≥–∞
    const password = document.getElementById('password-input').value.trim();
    const errorDiv = document.getElementById('password-error');
    const btn = document.getElementById('password-btn');
    
    if (!password) {
        errorDiv.textContent = '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å 2FA';
        errorDiv.style.display = 'block';
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> –ü—Ä–æ–≤–µ—Ä–∫–∞...';
    errorDiv.style.display = 'none';
    
    fetch(`/api/agents/${botId}/telegram/verify-code/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ 
            code: code,           // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ—Ç –∂–µ –∫–æ–¥
            password: password    // + –ø–∞—Ä–æ–ª—å 2FA
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
            document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
            document.getElementById('step-success').classList.add('active');
            document.querySelectorAll('.step-dot').forEach(d => d.classList.add('completed'));
        } else {
            errorDiv.textContent = data.error || '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å';
            errorDiv.style.display = 'block';
        }
    })
    .catch(error => {
        errorDiv.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
        errorDiv.style.display = 'block';
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fa-solid fa-lock"></i> –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å';
    });
}

// Auto-focus on inputs when steps change
document.addEventListener('DOMContentLoaded', function() {
    // Auto-submit on Enter key
    document.getElementById('api-id-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') saveApiCredentials();
    });
    document.getElementById('api-hash-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') saveApiCredentials();
    });
    document.getElementById('phone-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') sendCode();
    });
    document.getElementById('code-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') verifyCode();
    });
    document.getElementById('password-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') verifyWithPassword();
    });
});
</script>
{% endblock %}