{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Аналитика{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<style>
    /* ============================================
       HEADER STYLES
       ============================================ */
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
        gap: 20px;
        flex-wrap: wrap;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .header-icon-box {
        width: 60px;
        height: 60px;
        background: rgba(99, 102, 241, 0.1);
        border: 1px solid rgba(99, 102, 241, 0.3);
        border-radius: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.6rem;
        color: #818cf8;
        box-shadow: 0 0 20px rgba(99, 102, 241, 0.2);
    }

    .page-title {
        font-size: 2.2rem;
        font-weight: 800;
        margin: 0;
        line-height: 1.1;
        letter-spacing: -0.5px;
        color: white;
    }

    .page-subtitle {
        color: #94a3b8;
        font-size: 1.05rem;
        margin-top: 6px;
        font-weight: 400;
    }

    /* ============================================
       FILTERS & CONTROLS
       ============================================ */
    .analytics-controls {
        background: rgba(15, 23, 42, 0.4);
        backdrop-filter: blur(10px);
        border: 1px solid var(--dash-border);
        border-radius: 20px;
        padding: 20px;
        margin-bottom: 30px;
    }

    .filters-row {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        align-items: center;
        margin-bottom: 20px;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .filter-label {
        font-size: 12px;
        font-weight: 600;
        color: var(--dash-text-muted);
        text-transform: uppercase;
        margin-left: 4px;
    }

    .filter-select {
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid var(--dash-border);
        border-radius: 12px;
        padding: 10px 14px;
        color: white;
        font-size: 14px;
        min-width: 160px;
        cursor: pointer;
        transition: border-color 0.2s;
    }

    .filter-select:focus {
        outline: none;
        border-color: var(--dash-primary);
    }

    .date-range-picker {
        display: flex;
        align-items: center;
        gap: 10px;
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid var(--dash-border);
        border-radius: 12px;
        padding: 8px 14px;
    }

    .date-input {
        background: transparent;
        border: none;
        color: white;
        font-family: inherit;
        font-size: 14px;
        color-scheme: dark;
    }
    
    .date-input:focus { outline: none; }

    /* Period Buttons */
    .period-selector {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        padding-top: 20px;
        border-top: 1px solid rgba(255, 255, 255, 0.05);
    }

    .period-btn {
        padding: 8px 16px;
        border-radius: 10px;
        border: 1px solid var(--dash-border);
        background: rgba(255, 255, 255, 0.02);
        color: var(--dash-text-muted);
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .period-btn:hover {
        background: rgba(255, 255, 255, 0.05);
        color: white;
    }

    .period-btn.active {
        background: rgba(99, 102, 241, 0.15);
        border-color: var(--dash-primary);
        color: var(--dash-primary);
    }

    /* ============================================
       CHARTS GRID
       ============================================ */
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 24px;
        margin-bottom: 24px;
    }

    .chart-card {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid var(--dash-border);
        border-radius: 20px;
        padding: 24px;
        display: flex;
        flex-direction: column;
    }

    .chart-card.col-8 { grid-column: span 8; }
    .chart-card.col-6 { grid-column: span 6; }
    .chart-card.col-4 { grid-column: span 4; }
    .chart-card.col-12 { grid-column: span 12; }

    .chart-header {
        margin-bottom: 20px;
    }

    .chart-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: white;
        margin-bottom: 4px;
    }

    .chart-subtitle {
        font-size: 13px;
        color: var(--dash-text-muted);
    }

    .chart-container {
        position: relative;
        width: 100%;
    }
    .chart-container.large { height: 350px; }
    .chart-container.small { height: 250px; }

    /* Heatmap */
    .heatmap-container {
        overflow-x: auto;
        padding-bottom: 10px; /* Для скроллбара */
    }

    .heatmap {
        display: grid;
        grid-template-columns: 40px repeat(24, 1fr);
        gap: 4px;
        min-width: 800px; /* Чтобы не сжималось слишком сильно */
    }

    .heatmap-header {
        font-size: 10px;
        color: var(--dash-text-muted);
        text-align: center;
    }

    .heatmap-row-label {
        font-size: 11px;
        color: var(--dash-text-muted);
        display: flex;
        align-items: center;
        font-weight: 600;
    }

    .heatmap-cell {
        aspect-ratio: 1;
        border-radius: 4px;
        background: rgba(255, 255, 255, 0.03);
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
    }

    .heatmap-cell:hover {
        transform: scale(1.3);
        z-index: 10;
        box-shadow: 0 0 10px rgba(0,0,0,0.5);
        border: 1px solid rgba(255,255,255,0.2);
    }

    /* Heatmap Levels */
    .level-0 { background: rgba(255, 255, 255, 0.02); }
    .level-1 { background: rgba(99, 102, 241, 0.2); }
    .level-2 { background: rgba(99, 102, 241, 0.4); }
    .level-3 { background: rgba(99, 102, 241, 0.6); }
    .level-4 { background: rgba(99, 102, 241, 0.8); }
    .level-5 { background: #6366f1; box-shadow: 0 0 10px rgba(99, 102, 241, 0.4); }

    /* ============================================
       RESPONSIVE
       ============================================ */
    @media (max-width: 1200px) {
        .chart-card.col-8,
        .chart-card.col-4 {
            grid-column: span 12; /* На планшетах графики друг под другом */
        }
    }

    @media (max-width: 768px) {
        .dashboard-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 20px;
        }
        
        .filters-row {
            flex-direction: column;
            align-items: stretch;
        }

        .filter-select, .date-range-picker {
            width: 100%;
        }

        .btn {
            width: 100%;
            justify-content: center;
        }
        
        .period-selector {
            justify-content: flex-start;
            overflow-x: auto;
            padding-bottom: 10px;
        }
        
        .period-btn {
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .stats-grid {
            grid-template-columns: 1fr; /* Карточки статистики в одну колонку */
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-header">
    <div class="header-left">
        <div class="header-icon-box">
            <i class="fa-solid fa-chart-pie"></i>
        </div>
        <div>
            <h1 class="page-title">Аналитика</h1>
            <p class="page-subtitle">Отслеживайте ключевые показатели и конверсию</p>
        </div>
    </div>
    <div style="display: flex; gap: 12px;">
        <button class="btn btn-secondary" onclick="exportData()">
            <i class="fa-solid fa-download"></i> <span class="hide-mobile">Экспорт</span>
        </button>
        <button class="btn btn-primary" onclick="applyFilters()">
            <i class="fa-solid fa-rotate"></i> Обновить
        </button>
    </div>
</div>

<div class="analytics-controls">
    <div class="filters-row">
        <div class="filter-group">
            <label class="filter-label">Агент</label>
            <select class="filter-select" id="agent-filter">
                <option value="all">Все агенты</option>
                {% for bot in bots %}
                <option value="{{ bot.id }}">{{ bot.name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="filter-group">
            <label class="filter-label">Канал</label>
            <select class="filter-select" id="channel-filter">
                <option value="all">Все каналы</option>
                <option value="telegram">Telegram</option>
                <option value="whatsapp">WhatsApp</option>
                <option value="instagram">Instagram</option>
            </select>
        </div>
        
        <div class="filter-group" style="flex: 1;">
            <label class="filter-label">Период</label>
            <div class="date-range-picker">
                <input type="date" class="date-input" id="date-from">
                <span style="color: var(--dash-text-muted);">-</span>
                <input type="date" class="date-input" id="date-to">
            </div>
        </div>
    </div>
    
    <div class="period-selector">
        <button class="period-btn" data-period="today">Сегодня</button>
        <button class="period-btn" data-period="yesterday">Вчера</button>
        <button class="period-btn active" data-period="7days">7 дней</button>
        <button class="period-btn" data-period="30days">30 дней</button>
        <button class="period-btn" data-period="90days">90 дней</button>
        <button class="period-btn" data-period="year">Весь год</button>
    </div>
</div>

<div class="stats-grid" style="margin-bottom: 32px;">
    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-icon" style="background: rgba(99, 102, 241, 0.1); color: #818cf8;">
                <i class="fa-solid fa-comments"></i>
            </div>
            <span class="stat-change" id="change-conversations">--</span>
        </div>
        <div class="stat-value" id="stat-conversations">0</div>
        <div class="stat-label">Всего диалогов</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-icon" style="background: rgba(34, 197, 94, 0.1); color: #22c55e;">
                <i class="fa-solid fa-user-check"></i>
            </div>
            <span class="stat-change" id="change-leads">--</span>
        </div>
        <div class="stat-value" id="stat-leads">0</div>
        <div class="stat-label">Квалифицированных лидов</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-icon" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                <i class="fa-solid fa-percent"></i>
            </div>
            <span class="stat-change" id="change-conversion">--</span>
        </div>
        <div class="stat-value" id="stat-conversion">0%</div>
        <div class="stat-label">Конверсия в лид</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-header">
            <div class="stat-icon" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                <i class="fa-solid fa-stopwatch"></i>
            </div>
            <span class="stat-change" id="change-response-time">--</span>
        </div>
        <div class="stat-value" id="stat-response-time">0s</div>
        <div class="stat-label">Ср. время ответа</div>
    </div>
</div>

<div class="charts-grid">
    <div class="chart-card col-8">
        <div class="chart-header">
            <div>
                <div class="chart-title">Динамика обращений</div>
                <div class="chart-subtitle">Количество диалогов и лидов по дням</div>
            </div>
        </div>
        <div class="chart-container large">
            <canvas id="conversationsChart"></canvas>
        </div>
    </div>
    
    <div class="chart-card col-4">
        <div class="chart-header">
            <div>
                <div class="chart-title">Источники трафика</div>
                <div class="chart-subtitle">Распределение по каналам связи</div>
            </div>
        </div>
        <div class="chart-container small" style="margin-top: auto; margin-bottom: auto;">
            <canvas id="channelsChart"></canvas>
        </div>
    </div>
</div>

<div class="charts-grid">
    <div class="chart-card col-12">
        <div class="chart-header">
            <div>
                <div class="chart-title">Тепловая карта активности</div>
                <div class="chart-subtitle">Нагрузка по дням недели и часам</div>
            </div>
        </div>
        <div class="heatmap-container">
            <div class="heatmap" id="activity-heatmap">
                </div>
        </div>
    </div>
</div>

<div class="glass-card">
    <div class="card-header">
        <h2 class="card-title">
            <i class="fa-solid fa-medal" style="color: #f59e0b; margin-right: 10px;"></i>
            Эффективность агентов
        </h2>
    </div>
    <div class="table-responsive">
        <table class="data-table" id="agents-performance-table">
            <thead>
                <tr>
                    <th>Агент</th>
                    <th>Диалогов</th>
                    <th>Лидов</th>
                    <th>Конверсия</th>
                    <th>Статус</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>
</div>

<script>
// CSRF Token
const csrfToken = '{{ csrf_token }}';

// Chart.js Default Config
Chart.defaults.color = '#94a3b8';
Chart.defaults.borderColor = 'rgba(255,255,255,0.05)';
Chart.defaults.font.family = "'Inter', sans-serif";

// Global Chart Instances
let conversationsChart, channelsChart;
let currentPeriod = '7days';

// ========================================
// INITIALIZATION
// ========================================
document.addEventListener('DOMContentLoaded', function() {
    // Set default dates
    const today = new Date();
    const weekAgo = new Date(today);
    weekAgo.setDate(weekAgo.getDate() - 7);
    
    document.getElementById('date-to').valueAsDate = today;
    document.getElementById('date-from').valueAsDate = weekAgo;
    
    // Initialize empty charts
    initializeCharts();
    
    // Load initial data
    loadAnalyticsData();
    
    // Period buttons logic
    document.querySelectorAll('.period-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentPeriod = this.dataset.period;
            updateDateRangeFromPeriod(currentPeriod);
            loadAnalyticsData();
        });
    });
});

// ========================================
// DATA LOADING
// ========================================
async function loadAnalyticsData() {
    try {
        const params = getFilterParams();
        
        // Parallel loading for speed
        await Promise.all([
            loadSummary(params),
            loadConversationsChart(params),
            loadChannelsChart(params),
            loadActivityHeatmap(params),
            loadAgentsPerformance(params)
        ]);
        
    } catch (error) {
        console.error('Error loading analytics:', error);
        // Silent fail or toast notification
    }
}

function getFilterParams() {
    return {
        agent_id: document.getElementById('agent-filter').value,
        channel: document.getElementById('channel-filter').value,
        date_from: document.getElementById('date-from').value,
        date_to: document.getElementById('date-to').value,
        period: currentPeriod
    };
}

// 1. Summary Cards
async function loadSummary(params) {
    // Mock data if API fails (for demonstration)
    const summary = {
        total_conversations: 0,
        total_leads: 0,
        conversion_rate: 0,
        avg_response_time: 0,
        changes: { conversations: 0, leads: 0, conversion: 0, response_time: 0 }
    };
    
    try {
        const response = await fetch(`/api/analytics/summary/?${new URLSearchParams(params)}`);
        const data = await response.json();
        if (data.success) Object.assign(summary, data.data);
    } catch(e) {}

    animateValue('stat-conversations', summary.total_conversations);
    animateValue('stat-leads', summary.total_leads);
    document.getElementById('stat-conversion').textContent = summary.conversion_rate.toFixed(1) + '%';
    document.getElementById('stat-response-time').textContent = summary.avg_response_time + 's';
    
    updateStatChange('change-conversations', summary.changes.conversations);
    updateStatChange('change-leads', summary.changes.leads);
    updateStatChange('change-conversion', summary.changes.conversion);
    updateStatChange('change-response-time', summary.changes.response_time);
}

// 2. Line Chart
async function loadConversationsChart(params) {
    try {
        const response = await fetch(`/api/analytics/conversations-chart/?${new URLSearchParams(params)}`);
        const data = await response.json();
        
        if (data.success) {
            conversationsChart.data.labels = data.data.labels;
            conversationsChart.data.datasets[0].data = data.data.datasets[0].data;
            conversationsChart.data.datasets[1].data = data.data.datasets[1].data;
            conversationsChart.update();
        }
    } catch (e) {}
}

// 3. Doughnut Chart
async function loadChannelsChart(params) {
    try {
        const response = await fetch(`/api/analytics/channels-chart/?${new URLSearchParams(params)}`);
        const data = await response.json();
        
        if (data.success) {
            channelsChart.data.labels = data.data.labels;
            channelsChart.data.datasets[0].data = data.data.values;
            channelsChart.data.datasets[0].backgroundColor = data.data.colors || ['#6366f1', '#22c55e', '#ec4899'];
            channelsChart.update();
        }
    } catch (e) {}
}

// 4. Heatmap
async function loadActivityHeatmap(params) {
    try {
        const response = await fetch(`/api/analytics/activity-heatmap/?${new URLSearchParams(params)}`);
        const data = await response.json();
        if (data.success) buildHeatmap(data.data);
    } catch (e) {}
}

// 5. Agents Table
async function loadAgentsPerformance(params) {
    try {
        const response = await fetch(`/api/analytics/agents-performance/?${new URLSearchParams(params)}`);
        const data = await response.json();
        
        if (data.success) {
            const tbody = document.querySelector('#agents-performance-table tbody');
            tbody.innerHTML = '';
            
            if (data.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 20px;">Нет данных</td></tr>';
                return;
            }

            data.data.forEach(agent => {
                tbody.innerHTML += `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 32px; height: 32px; background: rgba(99, 102, 241, 0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 14px;">
                                    ${agent.avatar || '<i class="fa-solid fa-robot"></i>'}
                                </div>
                                <div>
                                    <div style="font-weight: 500;">${agent.name}</div>
                                </div>
                            </div>
                        </td>
                        <td>${agent.conversations}</td>
                        <td>${agent.leads || 0}</td>
                        <td>${agent.conversion}%</td>
                        <td>
                            <span class="status-badge ${agent.status === 'active' ? 'active' : 'inactive'}" style="padding: 4px 8px; font-size: 11px;">
                                <span class="status-dot"></span>
                                ${agent.status === 'active' ? 'Активен' : 'Неактивен'}
                            </span>
                        </td>
                    </tr>
                `;
            });
        }
    } catch (e) {}
}

// ========================================
// CHARTS SETUP
// ========================================
function initializeCharts() {
    // Line Chart
    const ctx1 = document.getElementById('conversationsChart').getContext('2d');
    
    // Gradient for line chart
    const gradient = ctx1.createLinearGradient(0, 0, 0, 300);
    gradient.addColorStop(0, 'rgba(99, 102, 241, 0.4)');
    gradient.addColorStop(1, 'rgba(99, 102, 241, 0.0)');

    conversationsChart = new Chart(ctx1, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Диалоги',
                data: [],
                borderColor: '#6366f1',
                backgroundColor: gradient,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#6366f1',
                pointRadius: 4,
                pointHoverRadius: 6
            }, {
                label: 'Лиды',
                data: [],
                borderColor: '#22c55e',
                backgroundColor: 'transparent',
                borderDash: [5, 5],
                tension: 0.4,
                pointRadius: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { display: true, position: 'top', align: 'end', labels: { usePointStyle: true, boxWidth: 6 } }
            },
            scales: {
                y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.03)' } },
                x: { grid: { display: false } }
            }
        }
    });

    // Doughnut Chart
    const ctx2 = document.getElementById('channelsChart').getContext('2d');
    channelsChart = new Chart(ctx2, {
        type: 'doughnut',
        data: {
            labels: [],
            datasets: [{
                data: [],
                borderWidth: 0,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '75%',
            plugins: {
                legend: { display: true, position: 'right', labels: { usePointStyle: true, boxWidth: 8, padding: 15 } }
            }
        }
    });
}

function buildHeatmap(data) {
    const container = document.getElementById('activity-heatmap');
    const days = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
    const hours = Array.from({length: 24}, (_, i) => i);
    
    let html = '<div class="heatmap-header"></div>';
    hours.forEach(h => html += `<div class="heatmap-header">${h}</div>`);
    
    days.forEach(day => {
        html += `<div class="heatmap-row-label">${day}</div>`;
        hours.forEach(h => {
            const cellData = data[day] && data[day][h] ? data[day][h] : {level: 0, value: 0};
            html += `<div class="heatmap-cell level-${cellData.level}" title="${day} ${h}:00 - ${cellData.value} диалогов"></div>`;
        });
    });
    
    container.innerHTML = html;
}

// ========================================
// UTILS
// ========================================
function updateStatChange(id, value) {
    const el = document.getElementById(id);
    if (!el) return;
    
    const val = parseFloat(value) || 0;
    const isPos = val >= 0;
    
    el.className = 'stat-change ' + (isPos ? 'positive' : 'negative');
    el.innerHTML = `<i class="fa-solid fa-arrow-${isPos ? 'up' : 'down'}"></i> ${Math.abs(val)}%`;
    
    // Style override for negative
    if (!isPos) el.style.color = '#ef4444';
    else el.style.color = '#22c55e';
}

function updateDateRangeFromPeriod(period) {
    const today = new Date();
    let fromDate = new Date(today);
    
    switch(period) {
        case 'yesterday': fromDate.setDate(today.getDate() - 1); break;
        case '7days': fromDate.setDate(today.getDate() - 7); break;
        case '30days': fromDate.setDate(today.getDate() - 30); break;
        case '90days': fromDate.setDate(today.getDate() - 90); break;
        case 'year': fromDate.setFullYear(today.getFullYear() - 1); break;
    }
    
    document.getElementById('date-from').valueAsDate = fromDate;
    document.getElementById('date-to').valueAsDate = today;
}

function applyFilters() {
    loadAnalyticsData();
    // Можно добавить уведомление
}

function animateValue(id, end) {
    const obj = document.getElementById(id);
    if (!obj) return;
    obj.innerHTML = end.toLocaleString();
}

function exportData() {
    const params = getFilterParams();
    window.location.href = `/api/analytics/export/?${new URLSearchParams(params)}`;
}
</script>
{% endblock %}