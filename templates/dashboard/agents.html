{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Мои агенты{% endblock %}

{% block content %}
<style>
    /* Стили для заголовка страницы */
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 40px;
        gap: 20px;
        flex-wrap: wrap;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .header-icon-box {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1));
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        color: #818cf8;
        box-shadow: 0 0 30px rgba(99, 102, 241, 0.15);
    }

    /* Кнопка создания */
    .btn-create {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        padding: 12px 28px;
        border-radius: 12px;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3), inset 0 1px 0 rgba(255,255,255,0.2);
        transition: all 0.2s;
        border: 1px solid rgba(255,255,255,0.1);
    }

    .btn-create:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(99, 102, 241, 0.5), inset 0 1px 0 rgba(255,255,255,0.2);
        color: white;
    }

    /* Дополнительные стили для иконок платформ */
    .platform-icon-tg { color: #229ED9; filter: drop-shadow(0 0 5px rgba(34, 158, 217, 0.4)); }
    .platform-icon-wa { color: #25D366; filter: drop-shadow(0 0 5px rgba(37, 211, 102, 0.4)); }
    .platform-icon-vk { color: #0077FF; filter: drop-shadow(0 0 5px rgba(0, 119, 255, 0.4)); }
    .platform-icon-in { color: #E4405F; filter: drop-shadow(0 0 5px rgba(228, 64, 95, 0.4)); }
    
    /* Адаптив */
    @media (max-width: 600px) {
        .dashboard-header { flex-direction: column; align-items: flex-start; }
        .btn-create { width: 100%; justify-content: center; }
    }
</style>

<div class="dashboard-header">
    <div class="header-left">
        <div class="header-icon-box">
            <i class="fa-solid fa-robot"></i>
        </div>
        <div>
            <h1 class="page-title" style="font-size: 28px; font-weight: 700; color: white; margin: 0;">Мои агенты</h1>
            <p style="color: var(--dash-text-muted); margin-top: 4px;">Управляйте своими чат-ботами</p>
        </div>
    </div>
    <a href="{% url 'create_agent' %}" class="btn-create">
        <i class="fa-solid fa-plus"></i>
        <span>Создать агента</span>
    </a>
</div>

{% if bots %}
    <div class="agents-grid">
        {% for bot in bots %}
            <div class="agent-card" onclick="window.location.href='{% url 'agent_detail' bot.id %}'">
                
                <div class="agent-content-pad">
                    <div class="agent-header">
                        <div class="agent-avatar">
                            {% if bot.platform == 'telegram' %}
                                <i class="fa-brands fa-telegram platform-icon-tg"></i>
                            {% elif bot.platform == 'whatsapp' %}
                                <i class="fa-brands fa-whatsapp platform-icon-wa"></i>
                            {% elif bot.platform == 'vk' %}
                                <i class="fa-brands fa-vk platform-icon-vk"></i>
                            {% elif bot.platform == 'instagram' %}
                                <i class="fa-brands fa-instagram platform-icon-in"></i>
                            {% else %}
                                <i class="fa-solid fa-robot"></i>
                            {% endif %}
                        </div>
                        <div class="agent-info">
                            <h3>{{ bot.name }}</h3>
                            <div class="agent-platform">
                                <span class="status-dot {% if bot.status == 'active' %}active{% endif %}" 
                                      style="background: {% if bot.status == 'active' %}#10b981{% else %}#94a3b8{% endif %}; box-shadow: 0 0 8px {% if bot.status == 'active' %}#10b981{% else %}transparent{% endif %};">
                                </span>
                                {{ bot.get_platform_display }}
                            </div>
                        </div>
                        
                        <div class="status-badge {% if bot.status == 'active' %}active{% else %}inactive{% endif %}" style="margin-left: auto;">
                            {% if bot.status == 'active' %}Активен{% else %}Пауза{% endif %}
                        </div>
                    </div>

                    {% if bot.description %}
                        <p style="color: var(--dash-text-muted); font-size: 13px; line-height: 1.5; margin-top: 12px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                            {{ bot.description }}
                        </p>
                    {% endif %}
                </div>

                <div class="agent-stats">
                    <div class="agent-stat">
                        <span class="agent-stat-value">{{ bot.total_conversations|default:"0" }}</span>
                        <span class="agent-stat-label">Диалогов</span>
                    </div>
                    <div class="agent-stat">
                        <span class="agent-stat-value">{{ bot.total_messages|default:"0" }}</span>
                        <span class="agent-stat-label">Сообщений</span>
                    </div>
                    <div class="agent-stat">
                        <span class="agent-stat-value" style="color: {% if bot.conversion_rate > 0 %}#10b981{% else %}inherit{% endif %}">
                            {{ bot.conversion_rate|default:"0" }}%
                        </span>
                        <span class="agent-stat-label">Конверсия</span>
                    </div>
                </div>

                <div class="agent-actions">
                    <button class="btn-icon" 
                            onclick="event.stopPropagation(); toggleBotStatus({{ bot.id }})" 
                            title="{% if bot.status == 'active' %}Остановить{% else %}Запустить{% endif %}"
                            style="flex: 1;">
                        <i class="fa-solid {% if bot.status == 'active' %}fa-pause{% else %}fa-play{% endif %}"></i>
                    </button>
                    
                    <button class="btn-icon" 
                            onclick="event.stopPropagation(); window.location.href='{% url 'agent_detail' bot.id %}'" 
                            title="Настройки"
                            style="flex: 1;">
                        <i class="fa-solid fa-gear"></i>
                    </button>
                    
                    <button class="btn-icon btn-danger" 
                            onclick="event.stopPropagation(); deleteBot({{ bot.id }}, '{{ bot.name }}')" 
                            title="Удалить"
                            style="flex: 1;">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>

            </div>
        {% endfor %}
    </div>

{% else %}
    <div class="empty-state glass-card">
        <div class="empty-icon">
            <i class="fa-solid fa-robot"></i>
        </div>
        <h3 class="empty-title">У вас пока нет агентов</h3>
        <p class="empty-text">
            Создайте своего первого ИИ-агента, подключите его к Telegram или WhatsApp и начните автоматизировать общение.
        </p>
        <a href="{% url 'create_agent' %}" class="btn btn-primary">
            <i class="fa-solid fa-plus"></i>
            Создать первого бота
        </a>
    </div>
{% endif %}

<script>
    function toggleBotStatus(botId) {
        const btn = event.currentTarget;
        const icon = btn.querySelector('i');
        // Анимация нажатия
        icon.style.transform = "scale(0.8)";
        setTimeout(() => icon.style.transform = "scale(1)", 200);

        fetch(`/api/agents/${botId}/toggle/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    function deleteBot(botId, botName) {
        if (!confirm(`Вы уверены, что хотите удалить агента "${botName}"?`)) return;
        
        fetch(`/api/agents/${botId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        });
    }
</script>

{% endblock %}